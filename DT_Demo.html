<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Digital Twins for Utilities</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1a6dcc;
            --primary-dark: #0d4d9c;
            --secondary: #00b894;
            --accent: #ff6b6b;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #eef2f7 100%);
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        /* Header */
        header {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1rem;
        }
        
        nav a {
            color: var(--dark);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        nav a:hover, nav a.active {
            background: var(--primary);
            color: white;
        }
        
        /* Hero */
        .hero {
            padding: 4rem 0;
            text-align: center;
            background: linear-gradient(135deg, rgba(26,109,204,0.1) 0%, rgba(0,184,148,0.1) 100%);
        }
        
        .hero h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .hero p {
            font-size: 1.1rem;
            color: var(--gray);
            max-width: 800px;
            margin: 0 auto 1.5rem;
        }
        
        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-success {
            background: var(--secondary);
            color: white;
        }
        
        /* Features */
        .features {
            padding: 4rem 0;
            background: white;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            transition: var(--transition);
            height: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 2rem 0;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid #eee;
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .tabs-header::-webkit-scrollbar {
            display: none;
        }
        
        .tab-btn {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .tab-btn:hover {
            color: var(--primary);
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: white;
        }
        
        .tab-content {
            padding: 1.5rem;
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.2rem;
            margin: 1.5rem 0;
        }
        
        .metric-card {
            background: var(--light);
            padding: 1.2rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0.5rem 0;
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 1.5rem 0;
        }
        
        .insight-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.2rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            border-left: 4px solid var(--secondary);
        }
        
        .insight-box h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Map */
        .map-wrapper {
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: 1.5rem 0;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--box-shadow);
            z-index: 1000;
            max-width: 200px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* Upload Section */
        .upload-container {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 2rem 0;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 3rem 2rem;
            margin: 1.5rem 0;
            transition: var(--transition);
        }
        
        .upload-area:hover {
            background: rgba(26, 109, 204, 0.05);
        }
        
        .upload-area.drag-over {
            background: rgba(26, 109, 204, 0.1);
            border-color: var(--secondary);
        }
        
        .file-types {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }
        
        .file-type-tag {
            background: var(--light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .ai-processing {
            background: linear-gradient(135deg, rgba(26,109,204,0.1) 0%, rgba(0,184,148,0.1) 100%);
            padding: 2rem;
            border-radius: var(--border-radius);
            margin: 2rem 0;
            display: none;
        }
        
        .ai-process-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        .report-section {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 1.5rem 0;
        }
        
        .section-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .section-metric {
            text-align: center;
            padding: 1rem;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        .section-metric .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.2rem;
            margin: 1.5rem 0;
        }
        
        .control-group {
            background: white;
            padding: 1.2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .data-table th, .data-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: var(--light);
            font-weight: 600;
        }
        
        /* Model Training */
        .model-training {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 1.5rem 0;
        }
        
        .model-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .model-metric {
            text-align: center;
            padding: 1rem;
            background: var(--light);
            border-radius: var(--border-radius);
        }
        
        /* Footer */
        footer {
            background: var(--dark);
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .tab-btn {
                padding: 0.8rem 1rem;
                min-width: 100px;
                font-size: 0.9rem;
            }
            
            .chart-container {
                padding: 1rem;
            }
            
            .map-legend {
                bottom: 10px;
                right: 10px;
                padding: 0.5rem;
                max-width: 150px;
            }
        }
        
        /* Utility classes */
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }
        
        .success { color: #2ecc71 !important; }
        .warning { color: #f39c12 !important; }
        .danger { color: #e74c3c !important; }
        .info { color: #3498db !important; }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .download-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }
        
        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .data-row {
            display: flex;
            gap: 1rem;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            font-weight: 600;
            min-width: 150px;
        }
        
        .uploaded-data-info {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-water"></i>
                <span>Utility Digital Twin</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#home" class="active" onclick="showPage('home')">Home</a></li>
                    <li><a href="#dashboard" onclick="showPage('dashboard')">Dashboard</a></li>
                    <li><a href="#digital-twin" onclick="showPage('digital-twin')">Digital Twin</a></li>
                    <li><a href="#upload" onclick="showPage('upload')">Upload Data</a></li>
                    <li><a href="#ai-report" onclick="showPage('ai-report')">AI Report</a></li>
                    <li><a href="#analytics" onclick="showPage('analytics')">Analytics</a></li>
                    <li><a href="#predictions" onclick="showPage('predictions')">Predictions</a></li>
                    <li><a href="#reports" onclick="showPage('reports')">Reports</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Home Page -->
    <section id="home-page" class="page active">
        <div class="hero">
            <div class="container">
                <h1>AI-Enabled Digital Twins for Utilities</h1>
                <p>Revolutionizing utility master planning with real-time simulation, predictive analytics, and AI-driven insights for water, sewer, and stormwater systems.</p>
                <div class="hero-buttons">
                    <button class="btn btn-primary" onclick="showPage('dashboard')">
                        <i class="fas fa-play-circle"></i> Launch Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('upload')">
                        <i class="fas fa-upload"></i> Upload Data
                    </button>
                    <button class="btn btn-success" onclick="showPage('ai-report')">
                        <i class="fas fa-robot"></i> Generate AI Report
                    </button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="container">
                <h2 style="text-align: center; margin-bottom: 1rem;">Key Features</h2>
                <p style="text-align: center; color: var(--gray); max-width: 800px; margin: 0 auto 2rem;">
                    Our AI-powered platform provides comprehensive utility planning and management capabilities
                </p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-map"></i>
                        </div>
                        <h3>Digital Twin Mapping</h3>
                        <p>Interactive 3D visualization of utility networks with real-time data integration</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h3>AI Predictions</h3>
                        <p>Machine learning models for failure prediction and risk assessment</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <h3>Data Integration</h3>
                        <p>Upload and analyze SHP, Excel, CSV, and GIS data formats</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <h3>Automated Reports</h3>
                        <p>Generate comprehensive AI-driven utility master plans</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Dashboard Page -->
    <section id="dashboard-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">Dashboard Overview</h1>
            
            <div class="dashboard-grid">
                <div class="metric-card">
                    <h4>System Health</h4>
                    <div class="metric-value">87%</div>
                    <p>Overall utility system performance</p>
                </div>
                
                <div class="metric-card">
                    <h4>Risk Level</h4>
                    <div class="metric-value warning">Medium</div>
                    <p>Current system risk assessment</p>
                </div>
                
                <div class="metric-card">
                    <h4>Cost Savings</h4>
                    <div class="metric-value success">$2.4M</div>
                    <p>Annual optimization savings</p>
                </div>
                
                <div class="metric-card">
                    <h4>Compliance</h4>
                    <div class="metric-value">94%</div>
                    <p>Regulatory compliance rate</p>
                </div>
            </div>
            
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="openDashboardTab('overview')">Overview</button>
                    <button class="tab-btn" onclick="openDashboardTab('water')">Water</button>
                    <button class="tab-btn" onclick="openDashboardTab('sewer')">Sewer</button>
                    <button class="tab-btn" onclick="openDashboardTab('stormwater')">Stormwater</button>
                    <button class="tab-btn" onclick="openDashboardTab('insights')">Insights</button>
                </div>
                
                <div id="dashboard-overview" class="tab-content active">
                    <div class="chart-container">
                        <h3>System Performance Trend</h3>
                        <canvas id="systemTrendChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-lightbulb"></i> Key Insight</h4>
                            <p>System performance has improved by 8% over the last 6 months due to infrastructure upgrades. Peak efficiency occurs during low-demand periods (11 PM - 5 AM).</p>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <div class="control-group">
                            <h4>Quick Actions</h4>
                            <button class="btn btn-primary" style="width: 100%; margin: 0.5rem 0;" onclick="generateReport()">
                                Generate Report
                            </button>
                            <button class="btn btn-secondary" style="width: 100%; margin: 0.5rem 0;" onclick="runAnalysis()">
                                Run Analysis
                            </button>
                        </div>
                        
                        <div class="control-group">
                            <h4>Recent Alerts</h4>
                            <div id="alerts-list"></div>
                        </div>
                    </div>
                </div>
                
                <div id="dashboard-water" class="tab-content">
                    <h3>Water System Analysis</h3>
                    <div class="chart-container">
                        <canvas id="waterChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-tint"></i> Water System Insights</h4>
                            <p>Water demand peaks at 7-9 AM and 6-8 PM. Zone 3 shows 15% higher consumption than average. Consider implementing smart metering in high-usage areas.</p>
                        </div>
                    </div>
                </div>
                
                <div id="dashboard-sewer" class="tab-content">
                    <h3>Sewer System Analysis</h3>
                    <div class="chart-container">
                        <canvas id="sewerChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-recycle"></i> Sewer System Insights</h4>
                            <p>Capacity utilization at 78% with peak loads during rainy seasons. 3 sections require immediate maintenance to prevent overflow risks.</p>
                        </div>
                    </div>
                </div>
                
                <div id="dashboard-stormwater" class="tab-content">
                    <h3>Stormwater System Analysis</h3>
                    <div class="chart-container">
                        <canvas id="stormwaterChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-cloud-rain"></i> Stormwater Insights</h4>
                            <p>System handles up to 2.5 inches of rainfall per hour. 4 drainage basins exceed 85% capacity during heavy rain events.</p>
                        </div>
                    </div>
                </div>
                
                <div id="dashboard-insights" class="tab-content">
                    <h3>AI-Generated Insights</h3>
                    <div class="insight-box">
                        <h4><i class="fas fa-chart-line"></i> Performance Trends</h4>
                        <p>Overall system efficiency increased by 12% YoY. Predictive maintenance reduced downtime by 35%.</p>
                    </div>
                    <div class="insight-box">
                        <h4><i class="fas fa-exclamation-triangle warning"></i> Risk Areas</h4>
                        <p>3 high-risk zones identified: Downtown (water pressure), Industrial Park (sewer capacity), North Hills (stormwater drainage).</p>
                    </div>
                    <div class="insight-box">
                        <h4><i class="fas fa-dollar-sign success"></i> Cost Optimization</h4>
                        <p>AI recommendations could save $450K annually through optimized pumping schedules and reduced energy consumption.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Digital Twin Page -->
    <section id="digital-twin-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">Digital Twin Visualization</h1>
            
            <div class="map-wrapper">
                <div id="map"></div>
                <div class="map-legend">
                    <h4 style="margin-bottom: 0.5rem;">Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Water Network</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span>Sewer Network</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>Stormwater</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Risk Zones</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>Uploaded Data</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <h4>Map Layers</h4>
                    <div>
                        <label><input type="checkbox" id="water-layer" checked onchange="toggleLayer('water')"> Water Network</label><br>
                        <label><input type="checkbox" id="sewer-layer" checked onchange="toggleLayer('sewer')"> Sewer Network</label><br>
                        <label><input type="checkbox" id="storm-layer" checked onchange="toggleLayer('storm')"> Stormwater</label><br>
                        <label><input type="checkbox" id="risk-layer" onchange="toggleLayer('risk')"> Risk Zones</label><br>
                        <label><input type="checkbox" id="uploaded-layer" onchange="toggleLayer('uploaded')"> Uploaded Data</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <h4>View Options</h4>
                    <button class="btn btn-primary" style="width: 100%; margin: 0.5rem 0;" onclick="zoomToExtent()">
                        Reset View
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin: 0.5rem 0;" onclick="exportMap()">
                        Export Map
                    </button>
                    <button class="btn btn-success" style="width: 100%; margin: 0.5rem 0;" onclick="runSpatialAnalysis()">
                        Run Spatial Analysis
                    </button>
                </div>
                
                <div class="control-group">
                    <h4>Uploaded Data</h4>
                    <div id="uploaded-data-info"></div>
                    <button class="btn btn-secondary" style="width: 100%; margin: 0.5rem 0;" onclick="clearUploadedData()">
                        Clear Uploaded Data
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Upload Data Page -->
    <section id="upload-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">Upload Utility Data</h1>
            
            <div class="upload-container">
                <h3><i class="fas fa-cloud-upload-alt"></i> Upload Your Data Files</h3>
                <p>Upload shapefiles, Excel spreadsheets, CSV files, or GIS data for AI analysis and report generation</p>
                
                <div class="file-types">
                    <div class="file-type-tag">
                        <i class="fas fa-layer-group"></i> SHP (Shapefiles)
                    </div>
                    <div class="file-type-tag">
                        <i class="fas fa-file-excel"></i> Excel (.xlsx, .xls)
                    </div>
                    <div class="file-type-tag">
                        <i class="fas fa-file-csv"></i> CSV Files
                    </div>
                    <div class="file-type-tag">
                        <i class="fas fa-database"></i> GIS Data
                    </div>
                    <div class="file-type-tag">
                        <i class="fas fa-map"></i> CAD Files
                    </div>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                    <h4>Drag & Drop Files Here</h4>
                    <p>or click to browse files</p>
                    <input type="file" id="fileInput" multiple accept=".shp,.dbf,.shx,.prj,.xlsx,.xls,.csv,.geojson,.kml,.dwg,.dxf" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-top: 1rem;">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                </div>
                
                <div id="fileList" style="text-align: left; margin-top: 1.5rem;"></div>
                
                <div class="uploaded-data-info">
                    <h4><i class="fas fa-info-circle"></i> Sample Data Available</h4>
                    <p>Don't have data? Use our sample datasets to test the platform:</p>
                    <div class="hero-buttons">
                        <button class="btn btn-secondary" onclick="loadSampleData('water')">
                            <i class="fas fa-tint"></i> Load Water Sample
                        </button>
                        <button class="btn btn-secondary" onclick="loadSampleData('sewer')">
                            <i class="fas fa-recycle"></i> Load Sewer Sample
                        </button>
                        <button class="btn btn-secondary" onclick="loadSampleData('stormwater')">
                            <i class="fas fa-cloud-rain"></i> Load Stormwater Sample
                        </button>
                    </div>
                </div>
                
                <div class="ai-processing" id="aiProcessing">
                    <h4><i class="fas fa-robot"></i> AI Processing Data</h4>
                    <div class="progress-bar">
                        <div class="progress" id="processingProgress"></div>
                    </div>
                    
                    <div id="processingSteps">
                        <!-- Steps will be added dynamically -->
                    </div>
                </div>
                
                <div class="model-training" id="modelTraining" style="display: none;">
                    <h4><i class="fas fa-brain"></i> AI Model Training</h4>
                    <div class="progress-bar">
                        <div class="progress" id="trainingProgress"></div>
                    </div>
                    <div class="model-metrics">
                        <div class="model-metric">
                            <div class="value">92%</div>
                            <p>Accuracy</p>
                        </div>
                        <div class="model-metric">
                            <div class="value">0.85</div>
                            <p>F1 Score</p>
                        </div>
                        <div class="model-metric">
                            <div class="value">0.89</div>
                            <p>Precision</p>
                        </div>
                        <div class="model-metric">
                            <div class="value">0.91</div>
                            <p>Recall</p>
                        </div>
                    </div>
                    <div class="insight-box">
                        <h4><i class="fas fa-chart-line"></i> Model Performance</h4>
                        <p>The AI model has been trained on 15,000 data points with 92% accuracy. The model can now predict failures with 85% confidence.</p>
                    </div>
                </div>
                
                <button class="btn btn-success" style="margin-top: 1.5rem;" onclick="processUploadedData()">
                    <i class="fas fa-play"></i> Process with AI
                </button>
            </div>
        </div>
    </section>

    <!-- AI Report Page -->
    <section id="ai-report-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">AI-Generated Master Plan Report</h1>
            
            <div class="report-section">
                <h2><i class="fas fa-water"></i> Water Network Analysis</h2>
                <div class="section-metrics">
                    <div class="section-metric">
                        <div class="value">325 km</div>
                        <p>Total Pipeline Length</p>
                    </div>
                    <div class="section-metric">
                        <div class="value">87%</div>
                        <p>System Efficiency</p>
                    </div>
                    <div class="section-metric">
                        <div class="value danger">18</div>
                        <p>Critical Assets</p>
                    </div>
                    <div class="section-metric">
                        <div class="value">$4.2M</div>
                        <p>Required Investment</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Water Distribution Analysis</h3>
                    <canvas id="waterNetworkChart"></canvas>
                    <div class="insight-box">
                        <h4><i class="fas fa-lightbulb"></i> AI Insights: Water Network</h4>
                        <p>The northern sector shows 23% higher water loss due to aging infrastructure. AI recommends pipe replacement in zones A3, B7, and C4. Smart meter installation could reduce consumption by 12%.</p>
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h2><i class="fas fa-road"></i> Road Network Analysis</h2>
                <div class="section-metrics">
                    <div class="section-metric">
                        <div class="value">156 km</div>
                        <p>Road Length</p>
                    </div>
                    <div class="section-metric">
                        <div class="value warning">42</div>
                        <p>Utility Cuts Needed</p>
                    </div>
                    <div class="section-metric">
                        <div class="value">$1.8M</div>
                        <p>Coordination Savings</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Road-Utility Corridor Analysis</h3>
                    <canvas id="roadNetworkChart"></canvas>
                    <div class="insight-box">
                        <h4><i class="fas fa-lightbulb"></i> AI Insights: Road Network</h4>
                        <p>Optimize utility work coordination along Main St and Broadway to reduce road cuts by 35%. AI suggests joint trenching for 8 utility upgrades scheduled in Q3 2024.</p>
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h2><i class="fas fa-users"></i> Population & Demand Analysis</h2>
                <div class="section-metrics">
                    <div class="section-metric">
                        <div class="value">245,000</div>
                        <p>Current Population</p>
                    </div>
                    <div class="section-metric">
                        <div class="value">+18%</div>
                        <p>5-Year Growth</p>
                    </div>
                    <div class="section-metric">
                        <div class="value warning">3</div>
                        <p>High-Growth Zones</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Population vs. Utility Demand</h3>
                    <canvas id="populationChart"></canvas>
                    <div class="insight-box">
                        <h4><i class="fas fa-lightbulb"></i> AI Insights: Population Trends</h4>
                        <p>Northwest corridor shows 28% population growth requiring capacity upgrades. AI predicts water demand increase of 15MLD by 2026. Sewer capacity needs expansion in growth zones G1-G3.</p>
                    </div>
                </div>
            </div>
            
            <div class="report-section">
                <h2><i class="fas fa-shield-alt"></i> Mitigation Strategies</h2>
                
                <div class="controls">
                    <div class="control-group">
                        <h4 class="success"><i class="fas fa-check-circle"></i> Short-term (0-2 years)</h4>
                        <ul>
                            <li>Replace 8 km of aging water pipes</li>
                            <li>Install 25 smart pressure sensors</li>
                            <li>Upgrade 3 pump stations</li>
                            <li>Cost: $3.2M | ROI: 4.2 years</li>
                        </ul>
                    </div>
                    
                    <div class="control-group">
                        <h4 class="warning"><i class="fas fa-clock"></i> Medium-term (2-5 years)</h4>
                        <ul>
                            <li>Expand wastewater treatment capacity</li>
                            <li>Implement IoT monitoring network</li>
                            <li>Stormwater retention basin upgrades</li>
                            <li>Cost: $8.5M | ROI: 6.1 years</li>
                        </ul>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-chart-line"></i> Long-term (5+ years)</h4>
                        <ul>
                            <li>Complete digital twin implementation</li>
                            <li>AI-driven predictive maintenance</li>
                            <li>Green infrastructure integration</li>
                            <li>Cost: $12M | ROI: 8.3 years</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="download-options">
                <button class="btn btn-primary" onclick="downloadReport('full')">
                    <i class="fas fa-file-pdf"></i> Download Full Report (PDF)
                </button>
                <button class="btn btn-secondary" onclick="downloadReport('executive')">
                    <i class="fas fa-file-alt"></i> Executive Summary
                </button>
                <button class="btn btn-success" onclick="downloadReport('data')">
                    <i class="fas fa-file-excel"></i> Download Data (Excel)
                </button>
            </div>
        </div>
    </section>

    <!-- Analytics Page -->
    <section id="analytics-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">Advanced Analytics</h1>
            
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="openAnalyticsTab('performance')">Performance</button>
                    <button class="tab-btn" onclick="openAnalyticsTab('demand')">Demand</button>
                    <button class="tab-btn" onclick="openAnalyticsTab('cost')">Cost Analysis</button>
                    <button class="tab-btn" onclick="openAnalyticsTab('scenarios')">Scenarios</button>
                    <button class="tab-btn" onclick="openAnalyticsTab('data')">Data Analysis</button>
                </div>
                
                <div id="analytics-performance" class="tab-content active">
                    <div class="chart-container">
                        <h3>System Performance Metrics</h3>
                        <canvas id="performanceChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-chart-line"></i> Performance Insights</h4>
                            <p>Water system shows 92% efficiency during peak hours. Sewer system capacity utilization varies by zone (65-88%). Stormwater system handles extreme events with 78% effectiveness.</p>
                        </div>
                    </div>
                </div>
                
                <div id="analytics-demand" class="tab-content">
                    <div class="chart-container">
                        <h3>Demand Forecasting</h3>
                        <canvas id="demandChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-lightbulb"></i> Demand Insights</h4>
                            <p>Water demand expected to grow 3.2% annually. Peak demand shifting to evening hours. Industrial zones show highest growth at 4.8% per year.</p>
                        </div>
                    </div>
                </div>
                
                <div id="analytics-cost" class="tab-content">
                    <div class="chart-container">
                        <h3>Cost-Benefit Analysis</h3>
                        <canvas id="costChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-dollar-sign"></i> Financial Insights</h4>
                            <p>Preventive maintenance yields 4:1 ROI. Smart meter deployment pays back in 3.2 years. Energy optimization could save $280K annually.</p>
                        </div>
                    </div>
                </div>
                
                <div id="analytics-scenarios" class="tab-content">
                    <div class="chart-container">
                        <h3>Scenario Analysis</h3>
                        <canvas id="scenarioChart"></canvas>
                        <div class="insight-box">
                            <h4><i class="fas fa-chess-board"></i> Scenario Insights</h4>
                            <p>Climate change scenario shows 23% higher stormwater requirements. High-growth scenario requires $18M additional investment. Optimal scenario balances growth with sustainability.</p>
                        </div>
                    </div>
                </div>
                
                <div id="analytics-data" class="tab-content">
                    <h3>Uploaded Data Analysis</h3>
                    <div id="data-analysis-content">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading data analysis...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Predictions Page -->
    <section id="predictions-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">AI Predictions</h1>
            
            <div class="dashboard-grid">
                <div class="metric-card">
                    <h4>Prediction Accuracy</h4>
                    <div class="metric-value success">92%</div>
                    <p>Machine learning model accuracy</p>
                </div>
                
                <div class="metric-card">
                    <h4>Risk Predictions</h4>
                    <div class="metric-value warning">18</div>
                    <p>High-risk assets identified</p>
                </div>
                
                <div class="metric-card">
                    <h4>Failure Predictions</h4>
                    <div class="metric-value danger">12</div>
                    <p>Predicted failures next quarter</p>
                </div>
                
                <div class="metric-card">
                    <h4>Savings Potential</h4>
                    <div class="metric-value success">$1.8M</div>
                    <p>Predictive maintenance savings</p>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Failure Prediction Timeline</h3>
                <canvas id="predictionChart"></canvas>
                <div class="insight-box">
                    <h4><i class="fas fa-exclamation-triangle warning"></i> Risk Insights</h4>
                    <p>Water mains in zones 3B and 7C show 85% failure probability within 6 months. Sewer lines along Market St require immediate inspection. Pump station #4 shows abnormal vibration patterns.</p>
                </div>
            </div>
            
            <div class="model-training">
                <h4><i class="fas fa-brain"></i> AI Model Training Data</h4>
                <div class="data-preview">
                    <div class="data-row">
                        <span class="data-label">Training Dataset:</span>
                        <span>15,000 utility asset records</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Features:</span>
                        <span>Age, Material, Diameter, Pressure, Flow Rate</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Target Variable:</span>
                        <span>Failure Probability (0-1)</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Training Duration:</span>
                        <span>45 minutes on GPU cluster</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Validation Score:</span>
                        <span class="success">0.92 F1 Score</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="runPredictions()">
                    <i class="fas fa-play"></i> Run Predictive Analysis
                </button>
                <button class="btn btn-secondary" onclick="trainModel()">
                    <i class="fas fa-brain"></i> Train AI Model
                </button>
                <button class="btn btn-success" onclick="showPage('ai-report')">
                    <i class="fas fa-file-alt"></i> Generate AI Report
                </button>
            </div>
        </div>
    </section>

    <!-- Reports Page -->
    <section id="reports-page" class="page hidden">
        <div class="container">
            <h1 style="margin: 1.5rem 0;">Reports & Documentation</h1>
            
            <div class="controls">
                <div class="control-group">
                    <h4>Generate Report</h4>
                    <select id="report-type" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
                        <option>Annual Master Plan</option>
                        <option>Risk Assessment</option>
                        <option>Compliance Report</option>
                        <option>Capital Plan</option>
                        <option>AI-Generated Master Plan</option>
                        <option>Sustainability Report</option>
                        <option>Data Analysis Report</option>
                    </select>
                    <button class="btn btn-primary" style="width: 100%; margin: 0.5rem 0;" onclick="generateReport()">
                        Generate
                    </button>
                    <button class="btn btn-success" style="width: 100%; margin: 0.5rem 0;" onclick="showPage('ai-report')">
                        <i class="fas fa-robot"></i> Generate AI Report
                    </button>
                </div>
                
                <div class="control-group">
                    <h4>Upload Data for Analysis</h4>
                    <button class="btn btn-secondary" style="width: 100%; margin: 0.5rem 0;" onclick="showPage('upload')">
                        <i class="fas fa-upload"></i> Go to Upload
                    </button>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Report History</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Report Name</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>AI Generated</th>
                            <th>Data Used</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="report-history">
                        <!-- Reports will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <h3>AI Digital Twins</h3>
                    <p>Revolutionizing utility planning with AI and real-time data.</p>
                </div>
                <div>
                    <h3>Contact</h3>
                    <p>demo@utilitydigitaltwin.com</p>
                </div>
                <div>
                    <h3>Supported Formats</h3>
                    <p>SHP, Excel, CSV, GIS, CAD</p>
                </div>
            </div>
            <p style="text-align: center; margin-top: 2rem; color: #aaa;">
                 2024 AI-Enabled Digital Twins for Utilities - Demo System
            </p>
        </div>
    </footer>

    <script>
        // Global variables
        let map;
        let charts = {};
        let uploadedFiles = [];
        let uploadedData = null;
        let uploadedLayer = null;
        let aiReportData = {};
        let sampleDatasets = {
            water: null,
            sewer: null,
            stormwater: null
        };
        
        // Enhanced dummy data with more realistic information
        const dummyData = {
            water: {
                efficiency: [85, 86, 88, 87, 89, 91, 92, 90],
                demand: [12.5, 13.2, 14.1, 15.2, 16.4, 17.8, 18.5, 19.2],
                failures: [2, 1, 3, 2, 1, 2, 3, 2],
                pressure: [45, 46, 44, 47, 45, 46, 48, 47],
                assets: [
                    {id: 1, type: 'Pipe', material: 'PVC', diameter: 12, age: 15, condition: 'Good'},
                    {id: 2, type: 'Valve', material: 'Bronze', diameter: 8, age: 22, condition: 'Fair'},
                    {id: 3, type: 'Pump', material: 'Steel', capacity: 500, age: 8, condition: 'Excellent'},
                    {id: 4, type: 'Pipe', material: 'Cast Iron', diameter: 24, age: 42, condition: 'Poor'},
                    {id: 5, type: 'Hydrant', material: 'Iron', diameter: 6, age: 18, condition: 'Good'}
                ]
            },
            sewer: {
                efficiency: [78, 79, 81, 82, 84, 85, 87, 86],
                capacity: [65, 66, 68, 70, 72, 74, 75, 76],
                issues: [5, 4, 6, 5, 4, 3, 5, 4],
                flow: [120, 125, 130, 128, 135, 140, 138, 142],
                assets: [
                    {id: 1, type: 'Sewer Main', material: 'Concrete', diameter: 18, age: 25, condition: 'Fair'},
                    {id: 2, type: 'Manhole', material: 'Brick', depth: 8, age: 35, condition: 'Poor'},
                    {id: 3, type: 'Lift Station', material: 'Steel', capacity: 1000, age: 12, condition: 'Good'}
                ]
            },
            stormwater: {
                efficiency: [72, 74, 75, 76, 78, 79, 81, 80],
                capacity: [60, 62, 64, 65, 67, 68, 70, 69],
                floodRisk: [3, 2, 4, 3, 2, 3, 4, 3],
                rainfall: [2.5, 3.1, 2.8, 4.2, 3.5, 2.9, 3.8, 4.1],
                assets: [
                    {id: 1, type: 'Catch Basin', material: 'Concrete', diameter: 36, age: 18, condition: 'Good'},
                    {id: 2, type: 'Drain Pipe', material: 'HDPE', diameter: 24, age: 8, condition: 'Excellent'},
                    {id: 3, type: 'Retention Pond', material: 'Earth', area: 5000, age: 15, condition: 'Fair'}
                ]
            },
            population: {
                current: 245000,
                growth: [2.5, 2.8, 3.1, 3.4, 3.7, 4.0, 4.3, 4.6],
                density: [1250, 1280, 1320, 1380, 1450, 1520, 1600, 1680]
            },
            system: {
                months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                performance: [82, 84, 83, 85, 87, 89, 88, 90],
                costs: [1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9]
            },
            predictions: [
                {assetId: 101, type: 'Water Pipe', location: 'Zone A', failureProbability: 0.85, predictedDate: '2024-06-15'},
                {assetId: 202, type: 'Sewer Line', location: 'Zone B', failureProbability: 0.72, predictedDate: '2024-07-20'},
                {assetId: 303, type: 'Pump Station', location: 'Zone C', failureProbability: 0.65, predictedDate: '2024-08-10'},
                {assetId: 404, type: 'Valve', location: 'Zone D', failureProbability: 0.58, predictedDate: '2024-09-05'}
            ]
        };
        
        // Sample GeoJSON data for visualization
        const sampleGeoJSON = {
            water: {
                type: "FeatureCollection",
                features: [
                    {
                        type: "Feature",
                        properties: {
                            name: "Main Water Line",
                            type: "Pipe",
                            diameter: 24,
                            material: "PVC",
                            age: 15,
                            condition: "Good"
                        },
                        geometry: {
                            type: "LineString",
                            coordinates: [
                                [-74.01, 40.71],
                                [-74.011, 40.72],
                                [-74.012, 40.73],
                                [-74.013, 40.74]
                            ]
                        }
                    },
                    {
                        type: "Feature",
                        properties: {
                            name: "Water Pump Station #1",
                            type: "Pump",
                            capacity: 500,
                            age: 8,
                            condition: "Excellent"
                        },
                        geometry: {
                            type: "Point",
                            coordinates: [-74.008, 40.715]
                        }
                    }
                ]
            },
            sewer: {
                type: "FeatureCollection",
                features: [
                    {
                        type: "Feature",
                        properties: {
                            name: "Main Sewer Line",
                            type: "Sewer",
                            diameter: 18,
                            material: "Concrete",
                            age: 25,
                            condition: "Fair"
                        },
                        geometry: {
                            type: "LineString",
                            coordinates: [
                                [-74.005, 40.708],
                                [-74.006, 40.715],
                                [-74.007, 40.722],
                                [-74.008, 40.728]
                            ]
                        }
                    }
                ]
            },
            stormwater: {
                type: "FeatureCollection",
                features: [
                    {
                        type: "Feature",
                        properties: {
                            name: "Storm Drain System",
                            type: "Drainage",
                            capacity: 1000,
                            material: "Concrete",
                            age: 18,
                            condition: "Good"
                        },
                        geometry: {
                            type: "Polygon",
                            coordinates: [[
                                [-74.015, 40.705],
                                [-74.010, 40.705],
                                [-74.010, 40.710],
                                [-74.015, 40.710],
                                [-74.015, 40.705]
                            ]]
                        }
                    }
                ]
            }
        };
        
        // AI Report data structure
        aiReportData = {
            waterNetwork: {
                totalLength: 325,
                efficiency: 87,
                criticalAssets: 18,
                investment: 4.2,
                zones: [
                    {name: 'Zone A', risk: 'High', length: 45, age: 42},
                    {name: 'Zone B', risk: 'Medium', length: 68, age: 28},
                    {name: 'Zone C', risk: 'Low', length: 89, age: 15}
                ]
            },
            roadNetwork: {
                totalLength: 156,
                utilityCuts: 42,
                coordinationSavings: 1.8,
                conflicts: [
                    {location: 'Main St', utilities: 5, priority: 'High'},
                    {location: 'Broadway', utilities: 4, priority: 'Medium'}
                ]
            },
            population: {
                current: 245000,
                growthRate: 3.2,
                density: 1450,
                hotspots: ['Northwest', 'Downtown', 'Eastside']
            },
            mitigation: {
                shortTerm: {
                    actions: ['Pipe replacement', 'Sensor installation', 'Pump upgrades'],
                    cost: 3.2,
                    roi: 4.2
                },
                mediumTerm: {
                    actions: ['Capacity expansion', 'IoT network', 'Basin upgrades'],
                    cost: 8.5,
                    roi: 6.1
                }
            }
        };
        
        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageId + '-page').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('active');
            });
            const targetLink = document.querySelector(`nav a[href="#${pageId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            
            // Initialize page content
            initializePage(pageId);
        }
        
        // Initialize page-specific content
        function initializePage(pageId) {
            switch(pageId) {
                case 'home':
                    break;
                    
                case 'dashboard':
                    initializeDashboard();
                    break;
                    
                case 'digital-twin':
                    initializeDigitalTwin();
                    break;
                    
                case 'upload':
                    initializeUpload();
                    break;
                    
                case 'ai-report':
                    initializeAIReport();
                    break;
                    
                case 'analytics':
                    initializeAnalytics();
                    break;
                    
                case 'predictions':
                    initializePredictions();
                    break;
                    
                case 'reports':
                    initializeReports();
                    break;
            }
        }
        
        // Upload functions
        function initializeUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }
        
        function handleFiles(files) {
            uploadedFiles = Array.from(files);
            displayFileList();
            
            // Process the first file if it's a JSON/GeoJSON file
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.type === 'FeatureCollection') {
                            uploadedData = data;
                            showNotification('GeoJSON data loaded successfully!', 'success');
                        }
                    } catch (error) {
                        // Not a JSON file, continue with other processing
                        console.log('Not a JSON file');
                    }
                };
                
                if (file.name.endsWith('.json') || file.name.endsWith('.geojson')) {
                    reader.readAsText(file);
                }
            }
        }
        
        function displayFileList() {
            const fileListDiv = document.getElementById('fileList');
            if (uploadedFiles.length === 0) {
                fileListDiv.innerHTML = '<p>No files selected</p>';
                return;
            }
            
            let html = '<h4>Selected Files:</h4><ul style="list-style: none; padding: 0;">';
            uploadedFiles.forEach((file, index) => {
                const icon = getFileIcon(file.name);
                html += `
                    <li style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--light); margin: 0.5rem 0; border-radius: 8px;">
                        ${icon}
                        <span style="flex-grow: 1;">${file.name} (${formatFileSize(file.size)})</span>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </li>
                `;
            });
            html += '</ul>';
            fileListDiv.innerHTML = html;
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['shp', 'dbf', 'shx', 'prj', 'geojson', 'kml'].includes(ext)) {
                return '<i class="fas fa-layer-group" style="color: var(--primary);"></i>';
            } else if (['xlsx', 'xls'].includes(ext)) {
                return '<i class="fas fa-file-excel" style="color: #2ecc71;"></i>';
            } else if (ext === 'csv') {
                return '<i class="fas fa-file-csv" style="color: var(--secondary);"></i>';
            } else if (['dwg', 'dxf'].includes(ext)) {
                return '<i class="fas fa-drafting-compass" style="color: #e74c3c;"></i>';
            }
            return '<i class="fas fa-file" style="color: var(--gray);"></i>';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            displayFileList();
        }
        
        function loadSampleData(type) {
            showNotification(`Loading ${type} sample data...`, 'info');
            
            // Store sample data
            sampleDatasets[type] = sampleGeoJSON[type];
            uploadedData = sampleGeoJSON[type];
            
            // Simulate file upload
            uploadedFiles = [{
                name: `${type}_sample_data.geojson`,
                size: JSON.stringify(sampleGeoJSON[type]).length
            }];
            
            displayFileList();
            
            setTimeout(() => {
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} sample data loaded successfully!`, 'success');
                processUploadedData();
            }, 1000);
        }
        
        function processUploadedData() {
            if (!uploadedData && uploadedFiles.length === 0) {
                showNotification('Please select files or load sample data first', 'warning');
                return;
            }
            
            const processingDiv = document.getElementById('aiProcessing');
            const stepsDiv = document.getElementById('processingSteps');
            const progressBar = document.getElementById('processingProgress');
            const modelTrainingDiv = document.getElementById('modelTraining');
            
            processingDiv.style.display = 'block';
            modelTrainingDiv.style.display = 'block';
            stepsDiv.innerHTML = '';
            progressBar.style.width = '0%';
            
            // Simulate AI processing steps
            const steps = [
                {icon: 'fas fa-upload', text: 'Uploading files...', duration: 1000},
                {icon: 'fas fa-cogs', text: 'Parsing data formats...', duration: 1500},
                {icon: 'fas fa-map', text: 'Geospatial analysis...', duration: 2000},
                {icon: 'fas fa-brain', text: 'Training AI models...', duration: 2500},
                {icon: 'fas fa-chart-bar', text: 'Generating insights...', duration: 1500},
                {icon: 'fas fa-file-alt', text: 'Compiling master plan...', duration: 1000}
            ];
            
            let progress = 0;
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'ai-process-step';
                    stepDiv.innerHTML = `
                        <i class="${step.icon}" style="color: var(--primary);"></i>
                        <span style="flex-grow: 1;">${step.text}</span>
                        <i class="fas fa-check success" style="display: none;"></i>
                        <div class="spinner" style="width: 20px; height: 20px;"></div>
                    `;
                    stepsDiv.appendChild(stepDiv);
                    
                    // Update progress
                    progress += (100 / steps.length);
                    progressBar.style.width = `${progress}%`;
                    
                    // Update training progress
                    document.getElementById('trainingProgress').style.width = `${progress}%`;
                    
                    // Mark step as complete
                    setTimeout(() => {
                        stepDiv.querySelector('.spinner').style.display = 'none';
                        stepDiv.querySelector('.fa-check').style.display = 'inline-block';
                    }, step.duration - 500);
                    
                    // If last step, show completion
                    if (index === steps.length - 1) {
                        setTimeout(() => {
                            showNotification('AI analysis complete! Data processed and model trained successfully.', 'success');
                            // Add uploaded data to map
                            if (uploadedData) {
                                addUploadedDataToMap();
                            }
                            // Navigate to AI report page
                            setTimeout(() => {
                                showPage('ai-report');
                            }, 1000);
                        }, step.duration);
                    }
                }, index * step.duration);
            });
        }
        
        // Digital Twin functions
        function initializeDigitalTwin() {
            if (!map) {
                map = L.map('map').setView([40.7128, -74.0060], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(map);
                
                // Add sample data layers
                addUtilityLayers();
                
                // Add uploaded data if exists
                if (uploadedData) {
                    addUploadedDataToMap();
                }
            }
            
            // Update uploaded data info
            updateUploadedDataInfo();
        }
        
        function addUtilityLayers() {
            // Add water network
            L.polyline([
                [40.7128, -74.0060],
                [40.7210, -74.0110],
                [40.7300, -74.0160],
                [40.7350, -74.0210]
            ], {color: '#3498db', weight: 4, opacity: 0.8}).addTo(map)
            .bindPopup('<b>Water Main Line</b><br>Diameter: 24"<br>Material: PVC<br>Age: 15 years')
            .setId('water-layer');
            
            // Add sewer network
            L.polyline([
                [40.7080, -74.0010],
                [40.7150, -74.0060],
                [40.7220, -74.0110],
                [40.7280, -74.0160]
            ], {color: '#9b59b6', weight: 4, opacity: 0.8}).addTo(map)
            .bindPopup('<b>Sewer Line</b><br>Diameter: 18"<br>Material: Concrete<br>Capacity: 85%')
            .setId('sewer-layer');
            
            // Add stormwater points
            L.circle([40.7100, -74.0080], {
                color: '#2ecc71',
                fillColor: '#2ecc71',
                radius: 250,
                fillOpacity: 0.3
            }).addTo(map).bindPopup('<b>Stormwater Basin</b><br>Capacity: 500,000 gal<br>Current: 65% full')
            .setId('storm-layer');
            
            // Add risk zones
            L.polygon([
                [40.7050, -74.0050],
                [40.7150, -74.0000],
                [40.7200, -74.0100],
                [40.7100, -74.0150]
            ], {color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.2})
            .addTo(map).bindPopup('<b>High Risk Zone</b><br>Multiple utility conflicts<br>Priority: Immediate action')
            .setId('risk-layer');
        }
        
        function addUploadedDataToMap() {
            if (!uploadedData || !map) return;
            
            // Remove existing uploaded layer
            if (uploadedLayer) {
                map.removeLayer(uploadedLayer);
            }
            
            // Create a new layer for uploaded data
            uploadedLayer = L.geoJSON(uploadedData, {
                style: function(feature) {
                    return {
                        color: '#f39c12',
                        weight: 3,
                        opacity: 0.8,
                        fillColor: '#f39c12',
                        fillOpacity: 0.3
                    };
                },
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: '#f39c12',
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function(feature, layer) {
                    let popupContent = '<b>' + (feature.properties.name || 'Feature') + '</b><br>';
                    for (const [key, value] of Object.entries(feature.properties)) {
                        if (key !== 'name') {
                            popupContent += `${key}: ${value}<br>`;
                        }
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(map);
            
            uploadedLayer.setId('uploaded-layer');
            
            // Fit map to show all layers
            const bounds = uploadedLayer.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds);
            }
            
            // Update uploaded data info
            updateUploadedDataInfo();
            
            // Check the uploaded layer checkbox
            document.getElementById('uploaded-layer').checked = true;
            
            showNotification('Uploaded data visualized on map!', 'success');
        }
        
        function updateUploadedDataInfo() {
            const infoDiv = document.getElementById('uploaded-data-info');
            if (uploadedData && uploadedData.features) {
                const featureCount = uploadedData.features.length;
                let types = new Set();
                uploadedData.features.forEach(feature => {
                    if (feature.properties && feature.properties.type) {
                        types.add(feature.properties.type);
                    }
                });
                
                infoDiv.innerHTML = `
                    <p><strong>Features:</strong> ${featureCount}</p>
                    <p><strong>Types:</strong> ${Array.from(types).join(', ')}</p>
                    <p><strong>Source:</strong> Uploaded Data</p>
                `;
            } else {
                infoDiv.innerHTML = '<p>No data uploaded yet.</p>';
            }
        }
        
        function toggleLayer(layerType) {
            const checkbox = document.getElementById(`${layerType}-layer`);
            const layers = {
                'water': () => map.eachLayer(l => l._leaflet_id && l._leaflet_id.includes('water-layer') && l.setStyle({opacity: checkbox.checked ? 0.8 : 0})),
                'sewer': () => map.eachLayer(l => l._leaflet_id && l._leaflet_id.includes('sewer-layer') && l.setStyle({opacity: checkbox.checked ? 0.8 : 0})),
                'storm': () => map.eachLayer(l => l._leaflet_id && l._leaflet_id.includes('storm-layer') && l.setStyle({opacity: checkbox.checked ? 0.3 : 0})),
                'risk': () => map.eachLayer(l => l._leaflet_id && l._leaflet_id.includes('risk-layer') && l.setStyle({fillOpacity: checkbox.checked ? 0.2 : 0})),
                'uploaded': () => {
                    if (uploadedLayer) {
                        uploadedLayer.setStyle({
                            opacity: checkbox.checked ? 0.8 : 0,
                            fillOpacity: checkbox.checked ? 0.3 : 0
                        });
                    }
                }
            };
            
            if (layers[layerType]) {
                layers[layerType]();
            }
        }
        
        function clearUploadedData() {
            if (uploadedLayer) {
                map.removeLayer(uploadedLayer);
                uploadedLayer = null;
            }
            uploadedData = null;
            uploadedFiles = [];
            
            // Uncheck uploaded layer checkbox
            document.getElementById('uploaded-layer').checked = false;
            
            // Update info
            updateUploadedDataInfo();
            
            showNotification('Uploaded data cleared from map', 'info');
        }
        
        function zoomToExtent() {
            map.setView([40.7128, -74.0060], 12);
        }
        
        function exportMap() {
            showNotification('Map exported as PNG file', 'success');
        }
        
        function runSpatialAnalysis() {
            showNotification('Running spatial analysis...', 'info');
            setTimeout(() => {
                showNotification('Analysis complete! 8 utility conflicts identified.', 'success');
            }, 2000);
        }
        
        // AI Report functions
        function initializeAIReport() {
            // Water network chart
            createChart('waterNetworkChart', {
                type: 'bar',
                data: {
                    labels: ['Zone A', 'Zone B', 'Zone C', 'Zone D', 'Zone E'],
                    datasets: [
                        {
                            label: 'Pipe Age (years)',
                            data: [42, 28, 15, 35, 22],
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Failure Risk %',
                            data: [85, 45, 20, 65, 40],
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Age (years)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Risk %'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Road network chart
            createChart('roadNetworkChart', {
                type: 'doughnut',
                data: {
                    labels: ['Water', 'Sewer', 'Gas', 'Electric', 'Telecom'],
                    datasets: [{
                        data: [35, 25, 15, 15, 10],
                        backgroundColor: [
                            '#3498db',
                            '#9b59b6',
                            '#e74c3c',
                            '#f39c12',
                            '#2ecc71'
                        ],
                        borderWidth: 2
                    }]
                }
            });
            
            // Population chart
            createChart('populationChart', {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023', '2024', '2025', '2026'],
                    datasets: [
                        {
                            label: 'Population',
                            data: [210, 218, 225, 232, 240, 248, 256],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Water Demand (MLD)',
                            data: [45, 47, 50, 53, 56, 60, 64],
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Population (thousands)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Water Demand (MLD)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // Dashboard functions
        function initializeDashboard() {
            // Create system trend chart
            createChart('systemTrendChart', {
                type: 'line',
                data: {
                    labels: dummyData.system.months,
                    datasets: [{
                        label: 'System Performance',
                        data: dummyData.system.performance,
                        borderColor: '#1a6dcc',
                        backgroundColor: 'rgba(26, 109, 204, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Performance: ${context.raw}%`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Create water chart
            createChart('waterChart', {
                type: 'line',
                data: {
                    labels: dummyData.system.months,
                    datasets: [
                        {
                            label: 'Efficiency',
                            data: dummyData.water.efficiency,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Pressure (PSI)',
                            data: dummyData.water.pressure,
                            borderColor: '#2ecc71',
                            borderDash: [5, 5]
                        }
                    ]
                }
            });
            
            // Create sewer chart
            createChart('sewerChart', {
                type: 'bar',
                data: {
                    labels: dummyData.system.months,
                    datasets: [
                        {
                            label: 'Capacity %',
                            data: dummyData.sewer.capacity,
                            backgroundColor: 'rgba(155, 89, 182, 0.7)'
                        },
                        {
                            label: 'Flow (L/s)',
                            data: dummyData.sewer.flow,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            type: 'line',
                            borderColor: '#3498db',
                            tension: 0.4
                        }
                    ]
                }
            });
            
            // Create stormwater chart
            createChart('stormwaterChart', {
                type: 'bar',
                data: {
                    labels: dummyData.system.months,
                    datasets: [
                        {
                            label: 'Rainfall (inches)',
                            data: dummyData.stormwater.rainfall,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Flood Risk',
                            data: dummyData.stormwater.floodRisk,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Rainfall (inches)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Flood Risk Index'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Load alerts
            loadAlerts();
        }
        
        function openDashboardTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('#dashboard-page .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected tab content
            document.querySelectorAll('#dashboard-page .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`dashboard-${tabId}`).classList.add('active');
        }
        
        // Analytics functions
        function initializeAnalytics() {
            // Performance chart
            createChart('performanceChart', {
                type: 'radar',
                data: {
                    labels: ['Efficiency', 'Reliability', 'Capacity', 'Safety', 'Cost', 'Sustainability'],
                    datasets: [
                        {
                            label: 'Water System',
                            data: [85, 92, 78, 95, 82, 88],
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: '#3498db',
                            pointBackgroundColor: '#3498db'
                        },
                        {
                            label: 'Sewer System',
                            data: [78, 85, 72, 90, 75, 82],
                            backgroundColor: 'rgba(155, 89, 182, 0.2)',
                            borderColor: '#9b59b6',
                            pointBackgroundColor: '#9b59b6'
                        },
                        {
                            label: 'Target',
                            data: [90, 95, 85, 98, 88, 92],
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            pointBackgroundColor: '#2ecc71'
                        }
                    ]
                }
            });
            
            // Demand chart
            createChart('demandChart', {
                type: 'line',
                data: {
                    labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030'],
                    datasets: [
                        {
                            label: 'Water Demand',
                            data: [12.5, 13.2, 14.1, 15.2, 16.4, 17.8, 19.2],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Sewer Demand',
                            data: [10.8, 11.5, 12.3, 13.2, 14.1, 15.0, 16.0],
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                }
            });
            
            // Cost chart
            createChart('costChart', {
                type: 'bar',
                data: {
                    labels: ['Maintenance', 'Upgrades', 'Energy', 'Labor', 'Materials', 'Compliance'],
                    datasets: [
                        {
                            label: 'Current Costs ($M)',
                            data: [2.5, 3.8, 1.2, 4.5, 2.8, 1.5],
                            backgroundColor: '#3498db'
                        },
                        {
                            label: 'Projected Savings ($M)',
                            data: [0.5, 1.2, 0.3, 0.8, 0.6, 0.4],
                            backgroundColor: '#2ecc71'
                        }
                    ]
                }
            });
            
            // Scenario chart
            createChart('scenarioChart', {
                type: 'bar',
                data: {
                    labels: ['Current', 'Growth', 'Climate', 'Combined', 'Optimized'],
                    datasets: [
                        {
                            label: 'Capital Required ($M)',
                            data: [42.5, 58.2, 51.8, 67.3, 45.2],
                            backgroundColor: '#e74c3c',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Risk Reduction (%)',
                            data: [0, 25, 18, 42, 35],
                            backgroundColor: '#2ecc71',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Capital ($M)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Risk Reduction (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Load data analysis
            loadDataAnalysis();
        }
        
        function loadDataAnalysis() {
            const contentDiv = document.getElementById('data-analysis-content');
            
            if (uploadedData && uploadedData.features) {
                let analysisHTML = `
                    <div class="uploaded-data-info">
                        <h4><i class="fas fa-database"></i> Uploaded Data Analysis</h4>
                        <p><strong>Total Features:</strong> ${uploadedData.features.length}</p>
                `;
                
                // Group by type
                const typeCounts = {};
                const ageStats = {sum: 0, count: 0, min: Infinity, max: -Infinity};
                
                uploadedData.features.forEach(feature => {
                    if (feature.properties) {
                        const type = feature.properties.type || 'Unknown';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                        
                        if (feature.properties.age) {
                            const age = Number(feature.properties.age);
                            ageStats.sum += age;
                            ageStats.count++;
                            ageStats.min = Math.min(ageStats.min, age);
                            ageStats.max = Math.max(ageStats.max, age);
                        }
                    }
                });
                
                analysisHTML += '<p><strong>Feature Types:</strong></p><ul>';
                for (const [type, count] of Object.entries(typeCounts)) {
                    analysisHTML += `<li>${type}: ${count} features</li>`;
                }
                analysisHTML += '</ul>';
                
                if (ageStats.count > 0) {
                    const avgAge = (ageStats.sum / ageStats.count).toFixed(1);
                    analysisHTML += `
                        <p><strong>Age Statistics:</strong></p>
                        <ul>
                            <li>Average Age: ${avgAge} years</li>
                            <li>Minimum Age: ${ageStats.min} years</li>
                            <li>Maximum Age: ${ageStats.max} years</li>
                        </ul>
                    `;
                }
                
                analysisHTML += `
                        <div class="insight-box">
                            <h4><i class="fas fa-lightbulb"></i> Analysis Insights</h4>
                            <p>Based on the uploaded data, AI has identified ${Object.keys(typeCounts).length} different asset types. 
                            ${ageStats.count > 0 ? `The average asset age is ${avgAge} years, indicating ${avgAge > 20 ? 'aging infrastructure that may require attention' : 'relatively new infrastructure in good condition'}.` : ''}</p>
                        </div>
                    </div>
                `;
                
                contentDiv.innerHTML = analysisHTML;
            } else {
                contentDiv.innerHTML = `
                    <div class="uploaded-data-info">
                        <h4><i class="fas fa-info-circle"></i> No Uploaded Data</h4>
                        <p>Upload data to see detailed analysis here.</p>
                        <button class="btn btn-primary" onclick="showPage('upload')">
                            <i class="fas fa-upload"></i> Upload Data
                        </button>
                    </div>
                `;
            }
        }
        
        function openAnalyticsTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('#analytics-page .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected tab content
            document.querySelectorAll('#analytics-page .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`analytics-${tabId}`).classList.add('active');
            
            // Load data analysis if that tab is selected
            if (tabId === 'data') {
                loadDataAnalysis();
            }
        }
        
        // Predictions functions
        function initializePredictions() {
            createChart('predictionChart', {
                type: 'line',
                data: {
                    labels: dummyData.system.months,
                    datasets: [
                        {
                            label: 'Predicted Failures',
                            data: [2, 3, 4, 3, 2, 1, 2, 3],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Actual Failures',
                            data: [1, 2, 3, 2, 1, 0, 1, 2],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Target',
                            data: [0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5],
                            borderColor: '#2ecc71',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                }
            });
        }
        
        function runPredictions() {
            showNotification('Running predictive analysis...', 'info');
            
            // Use dummy data for predictions
            const predictions = dummyData.predictions.map(pred => ({
                ...pred,
                confidence: Math.random().toFixed(2),
                recommendedAction: getRecommendedAction(pred.failureProbability)
            }));
            
            setTimeout(() => {
                showNotification('Analysis complete! Generated ' + predictions.length + ' predictions.', 'success');
                
                // Display predictions
                const chartContainer = document.querySelector('#predictions-page .chart-container');
                const predictionsHTML = `
                    <div class="data-preview">
                        <h4>AI Predictions</h4>
                        ${predictions.map(p => `
                            <div class="data-row">
                                <span class="data-label">${p.type}</span>
                                <span>Location: ${p.location}</span>
                                <span class="${p.failureProbability > 0.7 ? 'danger' : p.failureProbability > 0.5 ? 'warning' : 'success'}">
                                    Risk: ${(p.failureProbability * 100).toFixed(0)}%
                                </span>
                                <span>Action: ${p.recommendedAction}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                chartContainer.insertAdjacentHTML('beforeend', predictionsHTML);
            }, 2000);
        }
        
        function getRecommendedAction(probability) {
            if (probability > 0.7) return 'Immediate Inspection';
            if (probability > 0.5) return 'Schedule Maintenance';
            return 'Monitor';
        }
        
        function trainModel() {
            showNotification('Training AI model with uploaded data...', 'info');
            
            // Simulate model training with uploaded data
            setTimeout(() => {
                showNotification('Model training complete! Accuracy improved to 94%', 'success');
                
                // Update model metrics
                const metrics = document.querySelectorAll('.model-metric .value');
                metrics[0].textContent = '94%';
                metrics[1].textContent = '0.88';
                metrics[2].textContent = '0.91';
                metrics[3].textContent = '0.93';
                
                // Add training details
                const modelTrainingDiv = document.querySelector('.model-training');
                const trainingDetails = `
                    <div class="insight-box">
                        <h4><i class="fas fa-chart-line"></i> Training Results</h4>
                        <p>Model trained on ${uploadedData ? uploadedData.features.length + ' uploaded features' : '15,000 sample records'}. 
                        Validation accuracy improved by 2%. The model now includes ${uploadedData ? 'uploaded data patterns' : 'seasonal variations'} in predictions.</p>
                    </div>
                `;
                modelTrainingDiv.insertAdjacentHTML('beforeend', trainingDetails);
            }, 3000);
        }
        
        // Reports functions
        function initializeReports() {
            // Populate report history
            const reports = [
                {name: '2024 Master Plan', date: '2024-01-15', type: 'Annual', ai: true, data: 'Sample + Uploaded'},
                {name: 'Q1 Risk Assessment', date: '2024-03-31', type: 'Risk', ai: true, data: 'Uploaded'},
                {name: 'AI Master Plan', date: '2024-04-10', type: 'Master Plan', ai: true, data: 'Sample'},
                {name: 'Compliance Report', date: '2024-02-28', type: 'Compliance', ai: false, data: 'Internal'},
                {name: 'Capital Investment Plan', date: '2024-01-10', type: 'Capital', ai: true, data: 'Sample + Uploaded'},
                {name: 'Data Analysis Report', date: '2024-04-15', type: 'Analysis', ai: true, data: uploadedData ? 'Uploaded' : 'Sample'}
            ];
            
            const tbody = document.getElementById('report-history');
            tbody.innerHTML = '';
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.name}</td>
                    <td>${report.date}</td>
                    <td>${report.type}</td>
                    <td>${report.ai ? '<span class="success"><i class="fas fa-robot"></i> AI</span>' : '<span>Manual</span>'}</td>
                    <td>${report.data}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 0.25rem 0.5rem;" onclick="viewReport('${report.name}')">View</button>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="downloadReport('${report.name}')">Download</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            showNotification(`Generating ${reportType}...`, 'info');
            
            setTimeout(() => {
                showNotification(`${reportType} generated successfully!`, 'success');
                
                // Create report data based on type
                let reportData = '';
                if (reportType.includes('Data Analysis') && uploadedData) {
                    reportData = `Analyzed ${uploadedData.features.length} features from uploaded data`;
                } else if (reportType.includes('AI')) {
                    reportData = 'AI analysis based on sample + uploaded data';
                } else {
                    reportData = 'Combined dataset';
                }
                
                // Add to report history
                const newReport = {
                    name: `${new Date().getFullYear()} ${reportType}`,
                    date: new Date().toISOString().split('T')[0],
                    type: reportType.split(' ')[0],
                    ai: reportType.includes('AI'),
                    data: reportData
                };
                
                const tbody = document.getElementById('report-history');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${newReport.name}</td>
                    <td>${newReport.date}</td>
                    <td>${newReport.type}</td>
                    <td>${newReport.ai ? '<span class="success"><i class="fas fa-robot"></i> AI</span>' : '<span>Manual</span>'}</td>
                    <td>${newReport.data}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 0.25rem 0.5rem;" onclick="viewReport('${newReport.name}')">View</button>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="downloadReport('${newReport.name}')">Download</button>
                    </td>
                `;
                tbody.insertBefore(row, tbody.firstChild);
            }, 1500);
        }
        
        function downloadReport(type) {
            let fileName = '';
            let dataSource = '';
            
            switch(type) {
                case 'full':
                    fileName = 'AI_Master_Plan_Full_Report.pdf';
                    dataSource = uploadedData ? ' (Includes uploaded data)' : ' (Based on sample data)';
                    break;
                case 'executive':
                    fileName = 'Executive_Summary.pdf';
                    dataSource = uploadedData ? ' (Customized with your data)' : '';
                    break;
                case 'data':
                    fileName = 'Analysis_Data.xlsx';
                    dataSource = uploadedData ? ' (Your data + analysis)' : ' (Sample data + analysis)';
                    break;
                default:
                    fileName = `${type}_Report.pdf`;
                    dataSource = uploadedData ? ' (With uploaded data insights)' : '';
            }
            
            showNotification(`Downloading ${fileName}${dataSource}...`, 'info');
            
            // Simulate file download
            setTimeout(() => {
                showNotification(`${fileName} downloaded successfully!`, 'success');
                
                // Create a dummy download link
                const blob = new Blob(['Report content would be here'], {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 1000);
        }
        
        function viewReport(reportName) {
            showNotification(`Opening report: ${reportName}`, 'info');
            
            // Create a preview of the report
            const reportPreview = `
                <div class="report-section">
                    <h3>${reportName}</h3>
                    <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Data Source:</strong> ${uploadedData ? 'Uploaded data + Sample data' : 'Sample data'}</p>
                    <p><strong>AI Analysis:</strong> Yes</p>
                    <div class="insight-box">
                        <h4><i class="fas fa-file-alt"></i> Report Preview</h4>
                        <p>This report contains analysis of utility systems, predictions, and recommendations.</p>
                        <p>Key findings include:</p>
                        <ul>
                            <li>System efficiency: 87%</li>
                            <li>Risk assessment: Medium</li>
                            <li>Recommended investment: $4.2M</li>
                            <li>Predicted failures next quarter: 12</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Show modal or redirect to report page
            alert(`Report: ${reportName}\n\nThis is a preview. Use the download button for full report.`);
        }
        
        // Utility functions
        function createChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            
            // Default options
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                    // Add units based on dataset
                                    if (context.dataset.label?.includes('Cost') || context.dataset.label?.includes('$')) {
                                        label += 'M';
                                    } else if (context.dataset.label?.includes('%')) {
                                        label += '%';
                                    } else if (context.dataset.label?.includes('Pressure')) {
                                        label += ' PSI';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                }
            };
            
            // Merge default options with provided options
            config.options = { ...defaultOptions, ...config.options };
            
            // Create new chart
            charts[canvasId] = new Chart(ctx, config);
        }
        
        function loadAlerts() {
            const alerts = [
                {type: 'warning', message: 'Zone 3 water pressure below threshold (38 PSI)', time: '2 hours ago'},
                {type: 'info', message: 'Scheduled maintenance tomorrow - Main St affected', time: '1 day ago'},
                {type: 'success', message: 'System update completed successfully', time: '3 days ago'},
                {type: 'danger', message: 'High risk detected: Sewer line near Market St', time: '5 days ago'}
            ];
            
            const container = document.getElementById('alerts-list');
            container.innerHTML = '';
            
            alerts.forEach(alert => {
                const div = document.createElement('div');
                div.style.padding = '0.5rem';
                div.style.borderBottom = '1px solid #eee';
                div.innerHTML = `
                    <strong style="color: ${getAlertColor(alert.type)}"><i class="fas fa-exclamation-circle"></i> ${alert.type.toUpperCase()}</strong>
                    <div>${alert.message}</div>
                    <small style="color: #999">${alert.time}</small>
                `;
                container.appendChild(div);
            });
        }
        
        function getAlertColor(type) {
            switch(type) {
                case 'warning': return '#f39c12';
                case 'danger': return '#e74c3c';
                case 'success': return '#2ecc71';
                default: return '#3498db';
            }
        }
        
        function showNotification(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: type === 'success' ? '#2ecc71' : 
                              type === 'warning' ? '#f39c12' : 
                              type === 'danger' ? '#e74c3c' : '#3498db',
                stopOnFocus: true
            }).showToast();
        }
        
        function showDemo() {
            showNotification('Starting interactive demo...', 'info');
            setTimeout(() => {
                showPage('dashboard');
            }, 1000);
        }
        
        function runAnalysis() {
            showNotification('Running system analysis...', 'info');
            setTimeout(() => {
                showNotification('Analysis complete! 3 optimizations recommended.', 'success');
            }, 2000);
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize homepage
            initializePage('home');
            
            // Add some initial reports
            initializeReports();
            
            // Preload sample data
            Object.keys(sampleGeoJSON).forEach(type => {
                sampleDatasets[type] = sampleGeoJSON[type];
            });
        });
    </script>
</body>
</html>