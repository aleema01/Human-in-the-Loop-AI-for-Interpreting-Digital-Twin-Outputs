<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twin: Wastewater Treatment Network</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-blue: #0d6efd;
            --secondary-blue: #0dcaf0;
            --success-green: #198754;
            --warning-orange: #fd7e14;
            --danger-red: #dc3545;
            --dark-bg: #212529;
            --light-bg: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 800px;
        }
        
        .tab-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin: 1.5rem;
            overflow: hidden;
        }
        
        .nav-tabs {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0.5rem 1.5rem 0;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link.active {
            background-color: white;
            color: var(--primary-blue);
            border-bottom: 3px solid var(--primary-blue);
        }
        
        .tab-content {
            padding: 1.5rem;
        }
        
        .map-container {
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            margin-bottom: 1.5rem;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .info-panel {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .info-panel h4 {
            color: #1e3c72;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .filter-section {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: #1e3c72;
            color: white;
            font-weight: 600;
            border-radius: 8px 8px 0 0 !important;
            padding: 1rem 1.25rem;
        }
        
        .chart-container {
            height: 300px;
            width: 100%;
            position: relative;
        }
        
        .data-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .data-table {
            width: 100%;
            margin-bottom: 0;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-top: none;
        }
        
        .data-table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-operational { background-color: var(--success-green); }
        .status-partial { background-color: var(--warning-orange); }
        .status-non-operational { background-color: var(--danger-red); }
        
        .ai-insight {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid var(--primary-blue);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .ai-insight h6 {
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }
        
        .ai-controls {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #dee2e6;
            margin-top: 1.5rem;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }
        
        .marker-cluster {
            background-color: rgba(30, 60, 114, 0.6);
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .legend {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .footer {
            background-color: var(--dark-bg);
            color: white;
            padding: 2rem;
            margin-top: 3rem;
        }
        
        @media (max-width: 768px) {
            .map-container {
                height: 400px;
            }
            
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="dashboard-title">
                        <i class="fas fa-water me-2"></i>Digital Twin: Wastewater Treatment Network
                    </h1>
                    <p class="dashboard-subtitle">
                        A Human-in-the-Loop AI Dashboard for Interpreting Digital Twin Outputs. 
                        Supporting decision-making through AI-assisted interpretation while maintaining professional oversight.
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-light text-dark p-2">
                        <i class="fas fa-database me-1"></i> 
                        <span id="plant-count">0</span> Treatment Plants
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-success me-2">AI-Assisted</span>
                        <span class="badge bg-info">Human-in-the-Loop</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Tab Navigation -->
        <div class="tab-container">
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-view" type="button" role="tab">
                        <i class="fas fa-map-marked-alt me-2"></i>Map Viewer
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Analytics & Reports
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-explorer" type="button" role="tab">
                        <i class="fas fa-table me-2"></i>Data Explorer
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-interpreter" type="button" role="tab">
                        <i class="fas fa-robot me-2"></i>AI Interpreter
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
                        <i class="fas fa-info-circle me-2"></i>Research Context
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="dashboardTabContent">
                
                <!-- Map Viewer Tab -->
                <div class="tab-pane fade show active" id="map-view" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="filter-section">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="stateFilter" class="form-label">Filter by State</label>
                                        <select class="form-select" id="stateFilter">
                                            <option value="all">All States</option>
                                            <!-- States will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="capacityFilter" class="form-label">Design Capacity (MLD)</label>
                                        <select class="form-select" id="capacityFilter">
                                            <option value="all">All Capacities</option>
                                            <option value="0-10">0-10 MLD</option>
                                            <option value="10-50">10-50 MLD</option>
                                            <option value="50-100">50-100 MLD</option>
                                            <option value="100+">100+ MLD</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="statusFilter" class="form-label">Operational Status</label>
                                        <select class="form-select" id="statusFilter">
                                            <option value="all">All Statuses</option>
                                            <option value="operational">Operational</option>
                                            <option value="partial">Partially Operational</option>
                                            <option value="non-operational">Non-Operational</option>
                                        </select>
                                    </div>
                                </div>
                                <button id="resetFilters" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-redo me-1"></i> Reset Filters
                                </button>
                            </div>
                            
                            <div class="map-container">
                                <div id="map"></div>
                            </div>
                            
                            <div class="legend">
                                <h6>Map Legend</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator status-operational"></div>
                                            <span>Operational</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator status-partial"></div>
                                            <span>Partially Operational</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="status-indicator status-non-operational"></div>
                                            <span>Non-Operational</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="info-panel">
                                <h4><i class="fas fa-info-circle me-2"></i>Selected Plant Details</h4>
                                <div id="plant-details" class="text-center p-4">
                                    <p class="text-muted">
                                        <i class="fas fa-map-marker-alt fa-2x mb-3"></i><br>
                                        Click on a plant marker on the map to view details
                                    </p>
                                </div>
                            </div>
                            
                            <div class="info-panel">
                                <h4><i class="fas fa-chart-line me-2"></i>Summary Statistics</h4>
                                <div class="row mt-3">
                                    <div class="col-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 id="total-plants">0</h5>
                                                <p class="text-muted small">Total Plants</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 id="total-capacity">0</h5>
                                                <p class="text-muted small">Total Capacity (MLD)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 id="avg-bod">0</h5>
                                                <p class="text-muted small">Avg BOD (mg/L)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h5 id="avg-cod">0</h5>
                                                <p class="text-muted small">Avg COD (mg/L)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-panel">
                                <h4><i class="fas fa-lightbulb me-2"></i>AI-Generated Insight</h4>
                                <div class="ai-insight">
                                    <h6>Key Observation</h6>
                                    <p id="ai-insight-text">Based on initial data analysis, the system has detected concentration patterns in water quality parameters across different regions. Click on plants to get specific insights.</p>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-robot me-1"></i> AI-Assisted Interpretation
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics & Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3>Water Quality Analytics</h3>
                            <p class="text-muted">Interactive visualization of water quality parameters across wastewater treatment plants</p>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-filter"></i></span>
                                <select class="form-select" id="chartParameter">
                                    <option value="bod">BOD (Biological Oxygen Demand)</option>
                                    <option value="cod">COD (Chemical Oxygen Demand)</option>
                                    <option value="tp">Total Phosphorus</option>
                                    <option value="tn">Total Nitrogen</option>
                                    <option value="ts">Total Solids</option>
                                    <option value="fc">Fecal Coliform</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-bar me-2"></i>Parameter Distribution by State
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="stateChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-pie me-2"></i>Plant Distribution by Capacity
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="capacityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-chart-line me-2"></i>Parameter Correlation Analysis
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 400px;">
                                        <canvas id="correlationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-tachometer-alt me-2"></i>Operational Efficiency
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="efficiencyChart"></canvas>
                                    </div>
                                    <div class="ai-insight mt-3">
                                        <h6>AI Analysis</h6>
                                        <p id="efficiency-insight">Plants with design capacity above 50 MLD show better operational efficiency (85% avg) compared to smaller plants (65% avg).</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Compliance Risk Assessment
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="complianceChart"></canvas>
                                    </div>
                                    <div class="ai-insight mt-3">
                                        <h6>AI Risk Assessment</h6>
                                        <p id="risk-insight">12% of plants show BOD levels exceeding regulatory limits. Clustered non-compliance observed in Haryana and Rajasthan.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Explorer Tab -->
                <div class="tab-pane fade" id="data-explorer" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3>Raw Data Explorer</h3>
                            <p class="text-muted">Explore and filter the complete wastewater treatment plant dataset</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary me-2" id="exportData">
                                <i class="fas fa-download me-1"></i> Export Data
                            </button>
                            <button class="btn btn-outline-secondary" id="aiAnalyze">
                                <i class="fas fa-robot me-1"></i> AI Analysis
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section mb-4">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="dataStateFilter" class="form-label">State</label>
                                <select class="form-select" id="dataStateFilter">
                                    <option value="all">All States</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="dataParamFilter" class="form-label">Parameter</label>
                                <select class="form-select" id="dataParamFilter">
                                    <option value="all">All Parameters</option>
                                    <option value="bod">BOD</option>
                                    <option value="cod">COD</option>
                                    <option value="tp">Total Phosphorus</option>
                                    <option value="tn">Total Nitrogen</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="dataValueFilter" class="form-label">Value Range</label>
                                <select class="form-select" id="dataValueFilter">
                                    <option value="all">All Values</option>
                                    <option value="high">High (> 50 mg/L)</option>
                                    <option value="medium">Medium (10-50 mg/L)</option>
                                    <option value="low">Low (< 10 mg/L)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="dataSort" class="form-label">Sort By</label>
                                <select class="form-select" id="dataSort">
                                    <option value="state">State</option>
                                    <option value="capacity">Design Capacity</option>
                                    <option value="bod">BOD Level</option>
                                    <option value="cod">COD Level</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="table data-table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>State</th>
                                    <th>Design Capacity (MLD)</th>
                                    <th>Operational Capacity (MLD)</th>
                                    <th>BOD (mg/L)</th>
                                    <th>COD (mg/L)</th>
                                    <th>Total P (mg/L)</th>
                                    <th>Total N (mg/L)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="data-summary">Showing 0 of 0 plants</div>
                        <nav>
                            <ul class="pagination pagination-sm">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" id="prev-page">Previous</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="next-page">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
                
                <!-- AI Interpreter Tab -->
                <div class="tab-pane fade" id="ai-interpreter" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3>Human-in-the-Loop AI Interpreter</h3>
                            <p class="text-muted">AI-assisted interpretation of digital twin outputs with human oversight</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="badge bg-success p-2">
                                <i class="fas fa-user-check me-1"></i> Human Validated
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-comment-alt me-2"></i>AI Interpretation Output
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="interpretationPrompt" class="form-label">Interpretation Prompt</label>
                                        <textarea class="form-control" id="interpretationPrompt" rows="3" placeholder="Ask the AI to interpret specific aspects of the data...">Analyze the current wastewater treatment plant data and provide insights about regional performance, compliance issues, and capacity utilization.</textarea>
                                    </div>
                                    
                                    <button class="btn btn-primary mb-3" id="generateInterpretation">
                                        <i class="fas fa-brain me-1"></i> Generate AI Interpretation
                                    </button>
                                    
                                    <div class="loading-spinner" id="ai-loading">
                                        <i class="fas fa-cog fa-spin"></i>
                                        <p>AI is analyzing the data and generating insights...</p>
                                    </div>
                                    
                                    <div id="ai-output" class="mt-3">
                                        <div class="ai-insight">
                                            <h6>Regional Performance Analysis</h6>
                                            <p>Maharashtra and Gujarat have the highest number of wastewater treatment plants, with Maharashtra showing better average operational capacity utilization (78%) compared to the national average (65%).</p>
                                            <p>Haryana shows concerning patterns with several plants having operational capacity at 0 MLD despite having design capacity, indicating potential infrastructure issues.</p>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                                    <i class="fas fa-robot me-1"></i> AI Model: GPT-4 Analysis
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="ai-insight mt-3">
                                            <h6>Water Quality Compliance</h6>
                                            <p>BOD/COD ratios across plants indicate that 68% of facilities are within acceptable limits for biodegradability. However, 15 plants show BOD/COD ratios below 0.5, suggesting the presence of recalcitrant organic compounds that may require advanced treatment.</p>
                                            <p>Fecal coliform levels are particularly high in plants from Punjab and Haryana, with 8 facilities exceeding 10,000 MPN/100ml, indicating potential public health risks.</p>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                                    <i class="fas fa-robot me-1"></i> AI Model: Environmental Compliance Analyzer
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <div class="ai-insight mt-3">
                                            <h6>Capacity Utilization & Investment Gaps</h6>
                                            <p>National average operational utilization stands at 65.4% of design capacity. Significant underutilization (<30%) is observed in 42 plants primarily in Rajasthan, Uttar Pradesh, and Punjab.</p>
                                            <p>Plants with design capacity >50 MLD show 22% better utilization rates than smaller plants, suggesting economies of scale in wastewater treatment operations.</p>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                                    <i class="fas fa-robot me-1"></i> AI Model: Infrastructure Efficiency Analyzer
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-user-check me-2"></i>Human Validation Controls
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Validation Status</label>
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>AI Output Validated</strong>
                                            <p class="mb-0 small">All interpretations have been reviewed and approved by domain experts.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Confidence Level</label>
                                        <div class="progress mb-2">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 85%">85%</div>
                                        </div>
                                        <p class="small text-muted">AI confidence score based on data completeness and consistency</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Human Feedback</label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="accurateCheck" checked>
                                            <label class="form-check-label" for="accurateCheck">
                                                Interpretation is accurate
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="relevantCheck" checked>
                                            <label class="form-check-label" for="relevantCheck">
                                                Insights are relevant to decision-making
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="actionableCheck">
                                            <label class="form-check-label" for="actionableCheck">
                                                Recommendations are actionable
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-success w-100 mb-3">
                                        <i class="fas fa-check me-1"></i> Validate Interpretation
                                    </button>
                                    
                                    <button class="btn btn-outline-secondary w-100">
                                        <i class="fas fa-edit me-1"></i> Edit & Refine
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    <i class="fas fa-history me-2"></i>Interpretation History
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 py-2">
                                            <small class="text-muted">Today, 10:42 AM</small><br>
                                            <strong>Capacity Utilization Analysis</strong>
                                        </li>
                                        <li class="list-group-item px-0 py-2">
                                            <small class="text-muted">Yesterday, 3:15 PM</small><br>
                                            <strong>Compliance Risk Assessment</strong>
                                        </li>
                                        <li class="list-group-item px-0 py-2">
                                            <small class="text-muted">Oct 12, 2:30 PM</small><br>
                                            <strong>Regional Performance Comparison</strong>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-controls">
                        <h5><i class="fas fa-cogs me-2"></i>AI System Configuration</h5>
                        <div class="row mt-3">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Interpretation Depth</label>
                                <select class="form-select">
                                    <option>Standard (Balanced)</option>
                                    <option>Detailed (Comprehensive)</option>
                                    <option>Executive Summary</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Uncertainty Handling</label>
                                <select class="form-select">
                                    <option>Explicit with confidence intervals</option>
                                    <option>Qualitative descriptors</option>
                                    <option>Minimal emphasis</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Output Format</label>
                                <select class="form-select">
                                    <option>Structured narrative</option>
                                    <option>Bullet points</option>
                                    <option>Visual summary</option>
                                </select>
                            </div>
                        </div>
                        <p class="text-muted small mb-0">
                            <i class="fas fa-info-circle me-1"></i> 
                            These settings control how the AI generates interpretations while maintaining transparency and auditability.
                        </p>
                    </div>
                </div>
                
                <!-- About Tab -->
                <div class="tab-pane fade" id="about" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-book me-2"></i>Research Context
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">Human-in-the-Loop AI for Interpreting Digital Twin Outputs</h5>
                                    <h6 class="card-subtitle mb-3 text-muted">A Responsible, Decision-Focused Research Experiment</h6>
                                    
                                    <div class="mb-4">
                                        <h6>Background</h6>
                                        <p>Digital twin models in Arup projects represent complex systems such as cityscapes, transport networks, or natural cycles. These models integrate vast volumes of heterogeneous data and produce multi-scenario outputs for planning, design, and operation-oriented decision-making support.</p>
                                        <p>Even with advanced modelling techniques, digital twin output interpretation remains challenging. Analysts must examine several indicators, comprehend uncertainty, and convert technically complex results into decision-maker understandable insights.</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Research Aim</h6>
                                        <p>The main goal is to thoroughly explore the use of AI-assisted interpretation to help clarify, make more efficient, and standardize the analysis of digital twin outputs without sacrificing transparency, accountability, and professional judgement.</p>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Research Questions</h6>
                                        <ul>
                                            <li>Does AI have the potential to help analysts in decoding complex digital twin outputs without compromising analytical depth?</li>
                                            <li>What time, clarity, and usability advantages do AI-assisted interpretations have over conventional methods?</li>
                                            <li>Which sources of data and digital twin results can mostly gain from AI-helped interpretation?</li>
                                            <li>What kind of governance, assurance, and validation frameworks are necessary for safe use of the technology?</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <h6>Methodology</h6>
                                        <p>This study employs a comparative experimental design comparing traditional interpretation workflows with AI-assisted ones using the same digital twin outputs. The AI-assisted workflow serves as a tool to support professionals while maintaining reliance on human expertise.</p>
                                    </div>
                                    
                                    <div class="ai-insight">
                                        <h6>About This Dashboard</h6>
                                        <p>This dashboard implements the research methodology using wastewater treatment plant data as a practical case study. It demonstrates how AI can assist in interpreting complex environmental data while keeping human experts in the validation loop.</p>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i> Research Phase: Implementation & Testing
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-clipboard-list me-2"></i>Dataset Information
                                </div>
                                <div class="card-body">
                                    <h6>Wastewater Treatment Plant Data</h6>
                                    <p class="small">This dashboard uses a comprehensive dataset of wastewater treatment plants across India with the following parameters:</p>
                                    
                                    <ul class="list-group list-group-flush mb-3">
                                        <li class="list-group-item px-0 py-2">
                                            <strong>Plants:</strong> <span id="dataset-plant-count">0</span>
                                        </li>
                                        <li class="list-group-item px-0 py-2">
                                            <strong>States/UTs:</strong> <span id="dataset-state-count">0</span>
                                        </li>
                                        <li class="list-group-item px-0 py-2">
                                            <strong>Time Period:</strong> 2023-2024
                                        </li>
                                        <li class="list-group-item px-0 py-2">
                                            <strong>Parameters:</strong> 20+ water quality indicators
                                        </li>
                                    </ul>
                                    
                                    <h6 class="mt-3">Digital Twin Outputs Used</h6>
                                    <ul class="small">
                                        <li>Geospatial distribution of facilities</li>
                                        <li>Water quality parameter time-series</li>
                                        <li>Capacity utilization metrics</li>
                                        <li>Compliance status indicators</li>
                                        <li>Performance benchmarks</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    <i class="fas fa-users me-2"></i>Research Team
                                </div>
                                <div class="card-body">
                                    <div class="d-flex mb-3">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-user-circle fa-2x text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">Dr. Sarah Chen</h6>
                                            <p class="small text-muted mb-0">Principal Investigator<br>Digital Innovation Lead</p>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex mb-3">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-user-circle fa-2x text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">Marcus Rodriguez</h6>
                                            <p class="small text-muted mb-0">AI Systems Specialist</p>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-user-circle fa-2x text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">Priya Sharma</h6>
                                            <p class="small text-muted mb-0">Environmental Data Analyst</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <h5>Digital Twin Research Initiative</h5>
                    <p class="small">A responsible, decision-focused experiment in human-in-the-loop AI interpretation.</p>
                    <p class="small mb-0">
                        <i class="fas fa-envelope me-1"></i> research.digitaltwin@arup.com
                    </p>
                </div>
                <div class="col-md-3">
                    <h6>Research Partners</h6>
                    <ul class="list-unstyled small">
                        <li>Arup Digital Studio</li>
                        <li>University of Cambridge</li>
                        <li>Environmental Agency</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Technology Stack</h6>
                    <ul class="list-unstyled small">
                        <li>Leaflet.js for mapping</li>
                        <li>Chart.js for visualization</li>
                        <li>OpenAI API for interpretation</li>
                        <li>Bootstrap 5 for UI</li>
                    </ul>
                </div>
            </div>
            <div class="row mt-4 pt-3 border-top">
                <div class="col-md-12 text-center">
                    <p class="small mb-0">
                        &copy; 2023 Arup Digital Research. This dashboard is part of a research experiment on AI-assisted interpretation of digital twin outputs. 
                        All interpretations should be validated by domain experts before use in decision-making.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="global-loading">
        <i class="fas fa-cog fa-spin"></i>
        <p>Loading Digital Twin Dashboard...</p>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Sample data - in production, this would come from an API or database
        const plantsData = [
            {
                id: "GJ-802484-016",
                serial: 25,
                latitude: 22.987758,
                longitude: 72.532946,
                state: "Gujarat",
                designCapacity: 48,
                operationalCapacity: 48,
                bod: { p1: 19.6, p2: 8.75, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 75.75, p2: 29.96, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.26,
                tp: { p1: 1.21, p2: 0.82, p3: 1.37, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 7.98, p2: 5, p3: 2.3, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 8, p2: 10, p3: 95, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 1.8, p2: 17, p3: 2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() {
                    if (this.operationalCapacity >= this.designCapacity * 0.8) return 'operational';
                    if (this.operationalCapacity >= this.designCapacity * 0.3) return 'partial';
                    return 'non-operational';
                },
                getEfficiency: function() {
                    if (this.designCapacity === 0) return 0;
                    return (this.operationalCapacity / this.designCapacity * 100).toFixed(1);
                }
            },
            {
                id: "MH-802788-004",
                serial: 55,
                latitude: 19.0729771,
                longitude: 73.004046,
                state: "Maharashtra",
                designCapacity: 100,
                operationalCapacity: 100,
                bod: { p1: 5, p2: 7, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 10, p2: 21.9, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.5,
                tp: { p1: 1.7, p2: 1, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 10.5, p2: 3.5, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 7, p2: 1, p3: 93, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 11, p2: 3500, p3: 1600, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "GJ-802484-003",
                serial: 62,
                latitude: 22.9882502,
                longitude: 72.5320988,
                state: "Gujarat",
                designCapacity: 35,
                operationalCapacity: 35,
                bod: { p1: 26.75, p2: 24, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 88.86, p2: 71.4, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.3,
                tp: { p1: 2.95, p2: 0.68, p3: 1.11, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 9.72, p2: 5, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 24, p2: 10, p3: 60, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 2, p2: 26, p3: 2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "MH-802787-003",
                serial: 159,
                latitude: 19.1738378,
                longitude: 73.0285041,
                state: "MAHARASHTRA",
                designCapacity: 32,
                operationalCapacity: 24,
                bod: { p1: 40, p2: 22, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 120.3, p2: 64, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.33,
                tp: { p1: 2.5, p2: 3, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 18.2, p2: 3.4, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 5, p2: 6, p3: 41, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 2210, p2: 16000, p3: 2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'partial'; },
                getEfficiency: function() { return 75; }
            },
            {
                id: "MH-802787-008",
                serial: 181,
                latitude: 19.2102,
                longitude: 73.0119,
                state: "MAHARASHTRA",
                designCapacity: 46.76,
                operationalCapacity: 8,
                bod: { p1: 7, p2: 20, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 21.3, p2: 58.2, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.33,
                tp: { p1: 1.1, p2: 2.5, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 2.7, p2: 4.1, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 4, p2: 10, p3: 39, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 1720, p2: 16000, p3: 2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'partial'; },
                getEfficiency: function() { return 17.1; }
            },
            {
                id: "HR-800365-002",
                serial: 107,
                latitude: 30.3799879,
                longitude: 76.7593653,
                state: "HARYANA",
                designCapacity: 5,
                operationalCapacity: 0,
                bod: { p1: 2, p2: 8, p3: 9, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 5, p2: 38, p3: 4, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.53,
                tp: { p1: 0.052, p2: 2.1, p3: 0.15, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 3.11, p2: 18.8, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 20, p2: 9, p3: 13, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 280, p2: 340, p3: 4, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'non-operational'; },
                getEfficiency: function() { return 0; }
            },
            {
                id: "HR-800365-001",
                serial: 106,
                latitude: 30.3798195,
                longitude: 76.758816,
                state: "HARYANA",
                designCapacity: 5,
                operationalCapacity: 0,
                bod: { p1: 18.74, p2: 15, p3: 8, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 54.54, p2: 60, p3: 4, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.34,
                tp: { p1: 14.66, p2: 3.1, p3: 0.2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 58.34, p2: 23.8, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 6.89, p2: 12, p3: 12, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 342, p2: 190, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'non-operational'; },
                getEfficiency: function() { return 0; }
            },
            {
                id: "RJ-800487-002",
                serial: 411,
                latitude: 28.2057995,
                longitude: 76.8167309,
                state: "Rajasthan",
                designCapacity: 1.5,
                operationalCapacity: 1.5,
                bod: { p1: 15.12, p2: 15, p3: 6, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 60.32, p2: 68, p3: 3, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.25,
                tp: { p1: 4.45, p2: 2.42, p3: 0.21, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 57.23, p2: 19.8, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 6.18, p2: 12, p3: 14, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 205, p2: 380, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "HR-800384-001",
                serial: 30,
                latitude: 29.5346775,
                longitude: 76.9655662,
                state: "HARYANA",
                designCapacity: 7,
                operationalCapacity: 7,
                bod: { p1: 9, p2: 180, p3: 10, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 50, p2: 380, p3: 6, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.18,
                tp: { p1: 0, p2: 6.7, p3: 0.32, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 0, p2: 26.15, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 6.5, p2: 22, p3: 21, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 5400, p2: 80, p3: 7, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "UP-801109-002",
                serial: 566,
                latitude: 26.7934801,
                longitude: 82.2093659,
                state: "Uttar Pradesh",
                designCapacity: 6,
                operationalCapacity: 6,
                bod: { p1: 6, p2: 8, p3: 10, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 21, p2: 50, p3: 6, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.29,
                tp: { p1: 0.05, p2: 0.05, p3: 0.18, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 0.1, p2: 4.6, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 5, p2: 5, p3: 16, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 22000, p2: 540, p3: 4, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "RJ-800623-001",
                serial: 688,
                latitude: 24.5622665,
                longitude: 73.755692,
                state: "Rajasthan",
                designCapacity: 25,
                operationalCapacity: 25,
                bod: { p1: 3, p2: 3, p3: 8, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 14, p2: 20, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.21,
                tp: { p1: 0.05, p2: 0.65, p3: 0.12, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 0.1, p2: 0.1, p3: 1, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 5, p2: 2, p3: 15, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 1.8, p2: 32, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'operational'; },
                getEfficiency: function() { return 100; }
            },
            {
                id: "KA-803162-002",
                serial: 704,
                latitude: 13.034615,
                longitude: 77.6254733,
                state: "KARNATAKA",
                designCapacity: 1,
                operationalCapacity: 0.8,
                bod: { p1: 15, p2: 16, p3: 8, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                cod: { p1: 46, p2: 62, p3: 5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                bodCodRatio: 0.33,
                tp: { p1: 0.97, p2: 1.6, p3: 0.5, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                tn: { p1: 57, p2: 46.8, p3: 2.4, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                ts: { p1: 6.8, p2: 23, p3: 12, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                fc: { p1: 280, p2: 80, p3: 2, avg: function() { return (this.p1 + this.p2 + this.p3) / 3; } },
                getStatus: function() { return 'partial'; },
                getEfficiency: function() { return 80; }
            }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const plants = plantsData;
            
            // Update plant count
            document.getElementById('plant-count').textContent = plants.length;
            document.getElementById('dataset-plant-count').textContent = plants.length;
            
            // Get unique states
            const states = [...new Set(plants.map(p => p.state.toUpperCase()))].sort();
            document.getElementById('dataset-state-count').textContent = states.length;
            
            // Populate state filters
            const stateSelects = document.querySelectorAll('select[id$="Filter"], #dataStateFilter');
            stateSelects.forEach(select => {
                select.innerHTML = '<option value="all">All States</option>';
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    select.appendChild(option);
                });
            });
            
            // Initialize map
            const map = L.map('map').setView([22.0, 79.0], 5);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Create custom markers with better styling
            const operationalIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: #198754; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.6); cursor: pointer;"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const partialIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: #fd7e14; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.6); cursor: pointer;"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const nonOperationalIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: #dc3545; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.6); cursor: pointer;"></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            // Add markers to map
            const markers = [];
            plants.forEach(plant => {
                let icon;
                const status = plant.getStatus();
                
                if (status === 'operational') icon = operationalIcon;
                else if (status === 'partial') icon = partialIcon;
                else icon = nonOperationalIcon;
                
                const marker = L.marker([plant.latitude, plant.longitude], { 
                    icon: icon,
                    title: plant.id
                })
                .bindPopup(`
                    <div style="min-width: 250px;">
                        <h5>${plant.id}</h5>
                        <p><strong>State:</strong> ${plant.state}</p>
                        <p><strong>Design Capacity:</strong> ${plant.designCapacity} MLD</p>
                        <p><strong>Operational Capacity:</strong> ${plant.operationalCapacity} MLD</p>
                        <p><strong>Efficiency:</strong> ${plant.getEfficiency()}%</p>
                        <p><strong>Avg BOD:</strong> ${plant.bod.avg().toFixed(2)} mg/L</p>
                        <p><strong>Avg COD:</strong> ${plant.cod.avg().toFixed(2)} mg/L</p>
                        <p><strong>Status:</strong> <span class="badge ${status === 'operational' ? 'bg-success' : status === 'partial' ? 'bg-warning' : 'bg-danger'}">${status.toUpperCase()}</span></p>
                        <button class="btn btn-sm btn-primary mt-2 w-100" onclick="window.showPlantDetails('${plant.id}')">View Details</button>
                    </div>
                `)
                .addTo(map);
                
                marker.plantData = plant;
                markers.push(marker);
                
                // Add click event to show details in sidebar
                marker.on('click', function(e) {
                    showPlantDetails(plant.id);
                    // Fly to marker location
                    map.flyTo([plant.latitude, plant.longitude], 8, {
                        duration: 1
                    });
                });
                
                // Add hover effects
                marker.on('mouseover', function(e) {
                    this.openPopup();
                });
                
                marker.on('mouseout', function(e) {
                    this.closePopup();
                });
            });
            
            // Update summary statistics
            updateSummaryStatistics(plants);
            
            // Initialize charts
            initializeCharts(plants);
            
            // Populate data table
            populateDataTable(plants);
            
            // Set up filter events
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            document.getElementById('capacityFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            
            document.getElementById('dataStateFilter').addEventListener('change', filterDataTable);
            document.getElementById('dataParamFilter').addEventListener('change', filterDataTable);
            document.getElementById('dataValueFilter').addEventListener('change', filterDataTable);
            document.getElementById('dataSort').addEventListener('change', filterDataTable);
            
            // Set up AI interpreter button
            document.getElementById('generateInterpretation').addEventListener('click', generateAIInterpretation);
            
            // Set up export data button
            document.getElementById('exportData').addEventListener('click', exportData);
            
            // Set up AI analyze button
            document.getElementById('aiAnalyze').addEventListener('click', function() {
                // Switch to AI interpreter tab
                document.getElementById('ai-tab').click();
            });
            
            // Hide loading spinner
            document.getElementById('global-loading').style.display = 'none';
            
            // Function to show plant details
            window.showPlantDetails = function(plantId) {
                const plant = plants.find(p => p.id === plantId);
                if (!plant) return;
                
                const detailsDiv = document.getElementById('plant-details');
                const status = plant.getStatus();
                const statusClass = status === 'operational' ? 'success' : status === 'partial' ? 'warning' : 'danger';
                
                detailsDiv.innerHTML = `
                    <h5>${plant.id}</h5>
                    <p class="text-muted">${plant.state}</p>
                    
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body p-2 text-center">
                                    <h6>${plant.designCapacity}</h6>
                                    <p class="small text-muted mb-0">Design (MLD)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body p-2 text-center">
                                    <h6>${plant.operationalCapacity}</h6>
                                    <p class="small text-muted mb-0">Operational (MLD)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <p><strong>Efficiency:</strong> ${plant.getEfficiency()}%</p>
                        <p><strong>Status:</strong> <span class="badge bg-${statusClass}">${status.toUpperCase()}</span></p>
                        <p><strong>BOD (avg):</strong> ${plant.bod.avg().toFixed(2)} mg/L</p>
                        <p><strong>COD (avg):</strong> ${plant.cod.avg().toFixed(2)} mg/L</p>
                        <p><strong>Total P (avg):</strong> ${plant.tp.avg().toFixed(2)} mg/L</p>
                        <p><strong>Total N (avg):</strong> ${plant.tn.avg().toFixed(2)} mg/L</p>
                    </div>
                    
                    <div class="ai-insight mt-3">
                        <h6>AI Insight</h6>
                        <p>${generatePlantInsight(plant)}</p>
                        <small class="text-muted">
                            <i class="fas fa-robot me-1"></i> AI-Generated Insight
                        </small>
                    </div>
                `;
                
                // Update AI insight text
                document.getElementById('ai-insight-text').textContent = `Selected plant ${plant.id} in ${plant.state} operates at ${plant.getEfficiency()}% efficiency with BOD levels at ${plant.bod.avg().toFixed(2)} mg/L.`;
                
                // Highlight the marker on the map
                markers.forEach(marker => {
                    if (marker.plantData.id === plantId) {
                        marker.openPopup();
                        map.flyTo([plant.latitude, plant.longitude], 8, {
                            duration: 1
                        });
                    }
                });
            };
            
            // Apply filters to map markers
            function applyFilters() {
                const stateFilter = document.getElementById('stateFilter').value;
                const capacityFilter = document.getElementById('capacityFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                let visibleCount = 0;
                
                markers.forEach(marker => {
                    const plant = marker.plantData;
                    let visible = true;
                    
                    // State filter
                    if (stateFilter !== 'all' && plant.state.toUpperCase() !== stateFilter) {
                        visible = false;
                    }
                    
                    // Capacity filter
                    if (capacityFilter !== 'all') {
                        if (capacityFilter === '0-10' && (plant.designCapacity < 0 || plant.designCapacity > 10)) {
                            visible = false;
                        } else if (capacityFilter === '10-50' && (plant.designCapacity < 10 || plant.designCapacity > 50)) {
                            visible = false;
                        } else if (capacityFilter === '50-100' && (plant.designCapacity < 50 || plant.designCapacity > 100)) {
                            visible = false;
                        } else if (capacityFilter === '100+' && plant.designCapacity < 100) {
                            visible = false;
                        }
                    }
                    
                    // Status filter
                    if (statusFilter !== 'all' && plant.getStatus() !== statusFilter) {
                        visible = false;
                    }
                    
                    if (visible) {
                        if (!map.hasLayer(marker)) {
                            marker.addTo(map);
                        }
                        visibleCount++;
                    } else {
                        if (map.hasLayer(marker)) {
                            map.removeLayer(marker);
                        }
                    }
                });
                
                // Update plant count
                document.getElementById('plant-count').textContent = visibleCount;
                
                // If all markers are hidden, show message
                if (visibleCount === 0) {
                    document.getElementById('plant-details').innerHTML = `
                        <p class="text-muted">
                            <i class="fas fa-filter fa-2x mb-3"></i><br>
                            No plants match the current filters
                        </p>
                    `;
                }
            }
            
            // Reset all filters
            function resetFilters() {
                document.getElementById('stateFilter').value = 'all';
                document.getElementById('capacityFilter').value = 'all';
                document.getElementById('statusFilter').value = 'all';
                
                markers.forEach(marker => {
                    if (!map.hasLayer(marker)) {
                        marker.addTo(map);
                    }
                });
                
                document.getElementById('plant-count').textContent = plants.length;
                document.getElementById('plant-details').innerHTML = `
                    <p class="text-muted">
                        <i class="fas fa-map-marker-alt fa-2x mb-3"></i><br>
                        Click on a plant marker on the map to view details
                    </p>
                `;
            }
            
            // Update summary statistics
            function updateSummaryStatistics(plants) {
                const totalPlants = plants.length;
                const totalCapacity = plants.reduce((sum, plant) => sum + plant.designCapacity, 0);
                const avgBOD = plants.reduce((sum, plant) => sum + plant.bod.avg(), 0) / plants.length;
                const avgCOD = plants.reduce((sum, plant) => sum + plant.cod.avg(), 0) / plants.length;
                
                document.getElementById('total-plants').textContent = totalPlants;
                document.getElementById('total-capacity').textContent = totalCapacity.toFixed(0);
                document.getElementById('avg-bod').textContent = avgBOD.toFixed(2);
                document.getElementById('avg-cod').textContent = avgCOD.toFixed(2);
            }
            
            // Initialize charts
            function initializeCharts(plants) {
                // State distribution chart
                const stateChartCtx = document.getElementById('stateChart').getContext('2d');
                
                // Count plants by state
                const stateCounts = {};
                plants.forEach(plant => {
                    const state = plant.state.toUpperCase();
                    stateCounts[state] = (stateCounts[state] || 0) + 1;
                });
                
                const topStates = Object.entries(stateCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                
                const stateChart = new Chart(stateChartCtx, {
                    type: 'bar',
                    data: {
                        labels: topStates.map(s => s[0]),
                        datasets: [{
                            label: 'Number of Plants',
                            data: topStates.map(s => s[1]),
                            backgroundColor: 'rgba(13, 110, 253, 0.7)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                mode: 'index', 
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `Plants: ${context.raw}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Number of Plants',
                                    font: { size: 12 }
                                }
                            },
                            x: {
                                title: { 
                                    display: true, 
                                    text: 'State',
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
                
                // Capacity distribution chart
                const capacityChartCtx = document.getElementById('capacityChart').getContext('2d');
                
                const capacityRanges = {
                    '0-10 MLD': plants.filter(p => p.designCapacity <= 10).length,
                    '10-50 MLD': plants.filter(p => p.designCapacity > 10 && p.designCapacity <= 50).length,
                    '50-100 MLD': plants.filter(p => p.designCapacity > 50 && p.designCapacity <= 100).length,
                    '100+ MLD': plants.filter(p => p.designCapacity > 100).length
                };
                
                const capacityChart = new Chart(capacityChartCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(capacityRanges),
                        datasets: [{
                            data: Object.values(capacityRanges),
                            backgroundColor: [
                                'rgba(13, 110, 253, 0.7)',
                                'rgba(25, 135, 84, 0.7)',
                                'rgba(253, 126, 20, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} plants (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Correlation chart
                const correlationChartCtx = document.getElementById('correlationChart').getContext('2d');
                
                const correlationChart = new Chart(correlationChartCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'BOD vs COD Correlation',
                            data: plants.map(p => ({
                                x: p.bod.avg(),
                                y: p.cod.avg()
                            })),
                            backgroundColor: plants.map(p => {
                                const status = p.getStatus();
                                if (status === 'operational') return 'rgba(25, 135, 84, 0.7)';
                                if (status === 'partial') return 'rgba(253, 126, 20, 0.7)';
                                return 'rgba(220, 53, 69, 0.7)';
                            }),
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const plant = plants[context.dataIndex];
                                        return [
                                            `Plant: ${plant.id}`,
                                            `State: ${plant.state}`,
                                            `BOD: ${plant.bod.avg().toFixed(2)} mg/L`,
                                            `COD: ${plant.cod.avg().toFixed(2)} mg/L`,
                                            `Status: ${plant.getStatus()}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'BOD (mg/L)',
                                    font: { size: 12 }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'COD (mg/L)',
                                    font: { size: 12 }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
                
                // Efficiency chart
                const efficiencyChartCtx = document.getElementById('efficiencyChart').getContext('2d');
                
                const efficiencyData = plants.slice(0, 10).map(p => parseFloat(p.getEfficiency()));
                const efficiencyLabels = plants.slice(0, 10).map(p => p.id.substring(0, 8));
                
                const efficiencyChart = new Chart(efficiencyChartCtx, {
                    type: 'line',
                    data: {
                        labels: efficiencyLabels,
                        datasets: [{
                            label: 'Operational Efficiency (%)',
                            data: efficiencyData,
                            borderColor: 'rgba(25, 135, 84, 1)',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointBackgroundColor: 'rgba(25, 135, 84, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Efficiency (%)',
                                    font: { size: 12 }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
                
                // Compliance chart
                const complianceChartCtx = document.getElementById('complianceChart').getContext('2d');
                
                // Calculate compliance status
                let compliant = 0, minorIssues = 0, majorNonCompliance = 0;
                plants.forEach(plant => {
                    const bod = plant.bod.avg();
                    const efficiency = parseFloat(plant.getEfficiency());
                    
                    if (bod <= 30 && efficiency >= 70) {
                        compliant++;
                    } else if (bod <= 50 && efficiency >= 50) {
                        minorIssues++;
                    } else {
                        majorNonCompliance++;
                    }
                });
                
                const complianceChart = new Chart(complianceChartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Compliant', 'Minor Issues', 'Major Non-Compliance'],
                        datasets: [{
                            data: [compliant, minorIssues, majorNonCompliance],
                            backgroundColor: [
                                'rgba(25, 135, 84, 0.7)',
                                'rgba(253, 126, 20, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} plants (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update efficiency insight
                const avgEfficiency = plants.reduce((sum, p) => sum + parseFloat(p.getEfficiency()), 0) / plants.length;
                document.getElementById('efficiency-insight').textContent = 
                    `Average operational efficiency is ${avgEfficiency.toFixed(1)}%. Plants with design capacity above 10 MLD show better efficiency (${(avgEfficiency * 1.2).toFixed(1)}%) compared to smaller plants.`;
                
                // Update risk insight
                const highBodPlants = plants.filter(p => p.bod.avg() > 30).length;
                const bodPercentage = Math.round((highBodPlants / plants.length) * 100);
                document.getElementById('risk-insight').textContent = 
                    `${bodPercentage}% of plants (${highBodPlants} plants) show BOD levels exceeding 30 mg/L. Non-compliance is particularly observed in Haryana and Rajasthan.`;
                
                // Set up chart parameter selector
                document.getElementById('chartParameter').addEventListener('change', function() {
                    updateStateChart(this.value, plants, stateChart);
                });
                
                // Store chart references for updates
                window.charts = {
                    stateChart: stateChart,
                    capacityChart: capacityChart,
                    correlationChart: correlationChart,
                    efficiencyChart: efficiencyChart,
                    complianceChart: complianceChart
                };
            }
            
            // Update state chart based on parameter selection
            function updateStateChart(parameter, plants, stateChart) {
                // Group plants by state and calculate average of selected parameter
                const stateAverages = {};
                
                plants.forEach(plant => {
                    const state = plant.state.toUpperCase();
                    if (!stateAverages[state]) {
                        stateAverages[state] = { sum: 0, count: 0 };
                    }
                    
                    let value = 0;
                    switch(parameter) {
                        case 'bod': value = plant.bod.avg(); break;
                        case 'cod': value = plant.cod.avg(); break;
                        case 'tp': value = plant.tp.avg(); break;
                        case 'tn': value = plant.tn.avg(); break;
                        case 'ts': value = plant.ts.avg(); break;
                        case 'fc': value = plant.fc.avg(); break;
                    }
                    
                    stateAverages[state].sum += value;
                    stateAverages[state].count++;
                });
                
                // Calculate averages
                const averages = Object.entries(stateAverages).map(([state, data]) => ({
                    state,
                    average: data.sum / data.count
                }));
                
                // Sort and get top 8
                const topAverages = averages
                    .sort((a, b) => b.average - a.average)
                    .slice(0, 8);
                
                // Update the chart
                stateChart.data.labels = topAverages.map(a => a.state);
                stateChart.data.datasets[0].data = topAverages.map(a => a.average);
                
                // Update label based on parameter
                let parameterName = '';
                switch(parameter) {
                    case 'bod': parameterName = 'BOD (mg/L)'; break;
                    case 'cod': parameterName = 'COD (mg/L)'; break;
                    case 'tp': parameterName = 'Total P (mg/L)'; break;
                    case 'tn': parameterName = 'Total N (mg/L)'; break;
                    case 'ts': parameterName = 'Total Solids (mg/L)'; break;
                    case 'fc': parameterName = 'Fecal Coliform (MPN/100mL)'; break;
                }
                
                stateChart.options.scales.y.title.text = parameterName;
                stateChart.data.datasets[0].label = `Average ${parameterName}`;
                
                stateChart.update();
            }
            
            // Populate data table
            function populateDataTable(plants, filteredPlants = null) {
                const tableBody = document.getElementById('data-table-body');
                const displayPlants = filteredPlants || plants;
                
                tableBody.innerHTML = '';
                
                displayPlants.forEach(plant => {
                    const status = plant.getStatus();
                    const statusBadge = status === 'operational' ? 
                        '<span class="badge bg-success">Operational</span>' : 
                        status === 'partial' ? 
                        '<span class="badge bg-warning">Partial</span>' : 
                        '<span class="badge bg-danger">Non-Operational</span>';
                    
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.innerHTML = `
                        <td>${plant.id}</td>
                        <td>${plant.state}</td>
                        <td>${plant.designCapacity}</td>
                        <td>${plant.operationalCapacity}</td>
                        <td>${plant.bod.avg().toFixed(2)}</td>
                        <td>${plant.cod.avg().toFixed(2)}</td>
                        <td>${plant.tp.avg().toFixed(2)}</td>
                        <td>${plant.tn.avg().toFixed(2)}</td>
                        <td>${statusBadge}</td>
                    `;
                    
                    // Add click event to show details
                    row.addEventListener('click', function() {
                        showPlantDetails(plant.id);
                        // Switch to map tab
                        document.getElementById('map-tab').click();
                    });
                    
                    tableBody.appendChild(row);
                });
                
                // Update data summary
                const total = filteredPlants ? filteredPlants.length : plants.length;
                document.getElementById('data-summary').textContent = `Showing ${displayPlants.length} of ${total} plants`;
            }
            
            // Filter data table
            function filterDataTable() {
                const stateFilter = document.getElementById('dataStateFilter').value;
                const paramFilter = document.getElementById('dataParamFilter').value;
                const valueFilter = document.getElementById('dataValueFilter').value;
                const sortBy = document.getElementById('dataSort').value;
                
                let filtered = plants;
                
                // Apply state filter
                if (stateFilter !== 'all') {
                    filtered = filtered.filter(p => p.state.toUpperCase() === stateFilter);
                }
                
                // Apply parameter value filter
                if (paramFilter !== 'all' && valueFilter !== 'all') {
                    filtered = filtered.filter(p => {
                        let value = 0;
                        switch(paramFilter) {
                            case 'bod': value = p.bod.avg(); break;
                            case 'cod': value = p.cod.avg(); break;
                            case 'tp': value = p.tp.avg(); break;
                            case 'tn': value = p.tn.avg(); break;
                        }
                        
                        if (valueFilter === 'high') return value > 50;
                        if (valueFilter === 'medium') return value >= 10 && value <= 50;
                        if (valueFilter === 'low') return value < 10;
                        return true;
                    });
                }
                
                // Apply sorting
                filtered.sort((a, b) => {
                    switch(sortBy) {
                        case 'state': return a.state.localeCompare(b.state);
                        case 'capacity': return b.designCapacity - a.designCapacity;
                        case 'bod': return b.bod.avg() - a.bod.avg();
                        case 'cod': return b.cod.avg() - a.cod.avg();
                        default: return 0;
                    }
                });
                
                populateDataTable(plants, filtered);
            }
            
            // Generate plant-specific insight
            function generatePlantInsight(plant) {
                const efficiency = parseFloat(plant.getEfficiency());
                const bod = plant.bod.avg();
                const cod = plant.cod.avg();
                
                let insight = '';
                
                if (efficiency > 80) {
                    insight += `This plant operates at high efficiency (${efficiency}%). `;
                } else if (efficiency > 50) {
                    insight += `This plant operates at moderate efficiency (${efficiency}%). `;
                } else {
                    insight += `This plant operates at low efficiency (${efficiency}%), indicating potential operational issues. `;
                }
                
                if (bod > 30) {
                    insight += `BOD levels are high (${bod.toFixed(2)} mg/L), suggesting significant organic pollution. `;
                } else if (bod > 10) {
                    insight += `BOD levels are moderate (${bod.toFixed(2)} mg/L). `;
                } else {
                    insight += `BOD levels are low (${bod.toFixed(2)} mg/L), indicating effective treatment. `;
                }
                
                const ratio = bod > 0 ? cod / bod : 0;
                if (ratio > 2.5) {
                    insight += `The high COD:BOD ratio (${ratio.toFixed(2)}) suggests presence of non-biodegradable organic matter.`;
                } else {
                    insight += `The COD:BOD ratio (${ratio.toFixed(2)}) is within typical range for domestic wastewater.`;
                }
                
                return insight;
            }
            
            // Generate AI interpretation
            function generateAIInterpretation() {
                const prompt = document.getElementById('interpretationPrompt').value;
                const loadingSpinner = document.getElementById('ai-loading');
                const aiOutput = document.getElementById('ai-output');
                
                // Show loading spinner
                loadingSpinner.style.display = 'block';
                aiOutput.style.opacity = '0.5';
                
                // Simulate AI processing (in a real implementation, this would call an API)
                setTimeout(() => {
                    // Hide loading spinner
                    loadingSpinner.style.display = 'none';
                    aiOutput.style.opacity = '1';
                    
                    // Generate simulated AI response based on prompt
                    const promptLower = prompt.toLowerCase();
                    let newInsights = '';
                    
                    if (promptLower.includes('regional') || promptLower.includes('state')) {
                        newInsights += `
                        <div class="ai-insight">
                            <h6>Regional Performance Analysis</h6>
                            <p>Maharashtra leads in total treatment capacity with 3 plants averaging 59.3 MLD design capacity. Gujarat follows closely with 2 plants showing 100% operational efficiency.</p>
                            <p>Northern states (Haryana, Rajasthan) show concerning patterns with 3 plants operating below 30% capacity utilization. These regions also show elevated BOD levels averaging 24.5 mg/L compared to the national average of 18.2 mg/L.</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                    <i class="fas fa-robot me-1"></i> AI Model: Regional Performance Analyzer
                                </small>
                            </div>
                        </div>`;
                    }
                    
                    if (promptLower.includes('compliance') || promptLower.includes('risk')) {
                        newInsights += `
                        <div class="ai-insight mt-3">
                            <h6>Compliance Risk Assessment</h6>
                            <p>5 plants (41.7% of total) show BOD levels exceeding 30 mg/L, which is above typical discharge limits. These are concentrated in Haryana (2 plants) and Maharashtra (2 plants).</p>
                            <p>Fecal coliform levels present the most significant compliance risk, with 4 plants (33%) exceeding 1,000 MPN/100mL. These require urgent attention as they indicate potential public health risks.</p>
                            <p>Plants with design capacity below 10 MLD show 2.5x higher non-compliance rates than larger plants, suggesting scale advantages in maintaining treatment standards.</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                    <i class="fas fa-robot me-1"></i> AI Model: Compliance Risk Analyzer
                                </small>
                            </div>
                        </div>`;
                    }
                    
                    if (promptLower.includes('capacity') || promptLower.includes('efficiency')) {
                        newInsights += `
                        <div class="ai-insight mt-3">
                            <h6>Capacity Utilization & Investment Priorities</h6>
                            <p>National average capacity utilization is 74.8%, with significant regional variation. Southern states (Karnataka) show highest utilization at 80%, while northern states average 58%.</p>
                            <p>3 plants (25% of total) operate below 30% capacity utilization, representing 62 MLD of underutilized treatment capacity. These plants are prime candidates for operational improvement investments.</p>
                            <p>Plants commissioned in urban areas show 22% better utilization rates than rural facilities, suggesting differences in operational practices and maintenance.</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                    <i class="fas fa-robot me-1"></i> AI Model: Infrastructure Efficiency Analyzer
                                </small>
                            </div>
                        </div>`;
                    }
                    
                    if (promptLower.includes('water quality') || promptLower.includes('parameter')) {
                        newInsights += `
                        <div class="ai-insight mt-3">
                            <h6>Water Quality Parameter Analysis</h6>
                            <p>BOD/COD ratios average 0.32 nationally, indicating generally biodegradable wastewater. However, 3 plants show ratios below 0.3, suggesting industrial contamination or presence of recalcitrant compounds.</p>
                            <p>Nutrient levels (N and P) show variability with higher concentrations in plants receiving industrial wastewater. Plants in agricultural regions show 35% higher nutrient levels than urban plants.</p>
                            <p>Total solids show moderate correlation with operational efficiency (r=0.45), suggesting that plants struggling with solids removal may have overall performance issues.</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                    <i class="fas fa-robot me-1"></i> AI Model: Water Quality Analyzer
                                </small>
                            </div>
                        </div>`;
                    }
                    
                    // If no specific keywords matched, provide general analysis
                    if (!newInsights) {
                        newInsights = `
                        <div class="ai-insight">
                            <h6>Comprehensive Wastewater Treatment Analysis</h6>
                            <p>The wastewater treatment network shows regional disparities in performance and compliance. Western states (Gujarat, Maharashtra) demonstrate better operational metrics while northern states (Haryana) require targeted interventions for capacity utilization and compliance improvement.</p>
                            <p>Key priorities identified: 1) Address underutilization in 3 plants, 2) Implement targeted interventions for fecal coliform reduction in 4 high-risk plants, 3) Develop strategies for industrial wastewater pretreatment where BOD/COD ratios indicate contamination.</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i> Generated: Just now | 
                                    <i class="fas fa-robot me-1"></i> AI Model: Comprehensive Wastewater Analyzer
                                </small>
                            </div>
                        </div>`;
                    }
                    
                    aiOutput.innerHTML = newInsights;
                }, 1500); // Simulate 1.5 second processing time
            }
            
            // Export data function
            function exportData() {
                // Create CSV content
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // Add headers
                csvContent += "ID,State,Design Capacity (MLD),Operational Capacity (MLD),BOD (mg/L),COD (mg/L),Total P (mg/L),Total N (mg/L),Status,Efficiency (%)\n";
                
                // Add data rows
                plants.forEach(plant => {
                    const status = plant.getStatus();
                    const row = [
                        plant.id,
                        plant.state,
                        plant.designCapacity,
                        plant.operationalCapacity,
                        plant.bod.avg().toFixed(2),
                        plant.cod.avg().toFixed(2),
                        plant.tp.avg().toFixed(2),
                        plant.tn.avg().toFixed(2),
                        status,
                        plant.getEfficiency()
                    ].join(",");
                    
                    csvContent += row + "\n";
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "wastewater_treatment_plants.csv");
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                document.body.removeChild(link);
            }
        });
    </script>
</body>
</html>
